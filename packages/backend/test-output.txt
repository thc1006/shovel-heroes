
> shovel-backend@0.1.0 pretest
> node scripts/setup-test-db.js

[1m
============================================================[0m
[1m  Shovel Heroes - Test Database Setup[0m
[1m============================================================
[0m
[0mConfiguration:[0m
[0m  Host:     localhost:5432[0m
[0m  User:     postgres[0m
[0m  Database: shovelheroes_test
[0m
[34m[1/5] Checking PostgreSQL connection...[0m
[32m‚úì Connected to PostgreSQL: PostgreSQL 16.10 on x86_64-pc-linux-musl[0m
[34m[2/5] Checking if shovelheroes_test database exists...[0m
[0mDatabase shovelheroes_test exists, dropping it...[0m
[32m‚úì Dropped existing database: shovelheroes_test[0m
[34m[3/5] Creating test database: shovelheroes_test...[0m
[32m‚úì Test database shovelheroes_test created successfully[0m
[34m[4/5] Running migrations...[0m
[0m> shovel-backend@0.1.0 migrate:up
> node-pg-migrate up

> Migrating files:
> - 1696233600000_init
> - 1696237200000_rls
> - 1696240800000_audit
> - 1696244400000_create_all_tables
> - 1696248000000_expand_grids_table
> - 1696251600000_add_announcement_fields
> - 1696255200000_add_volunteer_registration_statuses
> - 1696258800000_add_grid_manager_column
> - 1696262400000_create_auth_system
> - 1696266000000_add_grid_code_unique_constraint
> - 1696269600000_auto_update_volunteer_count
> - 1696273200000_complete_rls_policies
> - 1696276800000_add_missing_columns
> - 1696280400000_modular_rls
### MIGRATION 1696233600000_init (UP) ###
-- Users and grids (minimal)
create table if not exists users (
  id uuid primary key default gen_random_uuid(),
  phone text,
  display_name text
);

create table if not exists grids (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  area_id text
);

-- app.user_id GUC
create schema if not exists app;
create or replace function app.current_user_id() returns uuid language sql stable as $$
  select nullif(current_setting('app.user_id', true), '')::uuid
$$;

-- Minimal seed
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696233600000_init', NOW());


### MIGRATION 1696237200000_rls (UP) ###
-- Enable row level security and policies
alter table grids enable row level security;

-- Example: allow select to all, but updates only to owner via a join (placeholder)
-- For demo, we keep read-only public access; extend as needed.
create policy grids_select_all on grids for select using (true);
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696237200000_rls', NOW());


### MIGRATION 1696240800000_audit (UP) ###
-- Append-only audit table with trigger
create table if not exists audit_log (
  id bigserial primary key,
  at timestamptz not null default now(),
  table_name text not null,
  op text not null,
  row_id text,
  actor uuid,
  diff jsonb
);

create or replace function app.audit_trigger() returns trigger language plpgsql as $$
begin
  insert into audit_log(table_name, op, row_id, actor, diff)
  values (TG_TABLE_NAME, TG_OP, coalesce(NEW::text, OLD::text), app.current_user_id(), 
          case when TG_OP='INSERT' then to_jsonb(NEW)
               when TG_OP='UPDATE' then jsonb_build_object('old', to_jsonb(OLD), 'new', to_jsonb(NEW))
               else to_jsonb(OLD) end);
  return coalesce(NEW, OLD);
end;
$$;

-- Example: add trigger to grids
drop trigger if exists audit_grids on grids;
create trigger audit_grids after insert or update or delete on grids
for each row execute function app.audit_trigger();
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696240800000_audit', NOW());


### MIGRATION 1696244400000_create_all_tables (UP) ###
-- Migration 0004: Create all missing tables for Shovel Heroes
-- Generated: 2025-10-02

-- Disaster Areas table
CREATE TABLE IF NOT EXISTS disaster_areas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  location TEXT,
  severity TEXT CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  status TEXT CHECK (status IN ('active', 'resolved', 'monitoring')) DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Announcements table
CREATE TABLE IF NOT EXISTS announcements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  priority TEXT CHECK (priority IN ('low', 'normal', 'high', 'urgent')) DEFAULT 'normal',
  published BOOLEAN DEFAULT FALSE,
  author_id UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Volunteers table
CREATE TABLE IF NOT EXISTS volunteers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  name TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  skills TEXT[],
  availability TEXT,
  status TEXT CHECK (status IN ('available', 'assigned', 'unavailable')) DEFAULT 'available',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Volunteer Registrations table
CREATE TABLE IF NOT EXISTS volunteer_registrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  volunteer_id UUID REFERENCES volunteers(id),
  grid_id UUID REFERENCES grids(id),
  disaster_area_id UUID REFERENCES disaster_areas(id),
  registration_date TIMESTAMPTZ DEFAULT NOW(),
  status TEXT CHECK (status IN ('pending', 'confirmed', 'cancelled')) DEFAULT 'pending',
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Supply Donations table
CREATE TABLE IF NOT EXISTS supply_donations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  donor_name TEXT NOT NULL,
  donor_contact TEXT,
  item_type TEXT NOT NULL,
  quantity INTEGER DEFAULT 1,
  unit TEXT,
  disaster_area_id UUID REFERENCES disaster_areas(id),
  grid_id UUID REFERENCES grids(id),
  status TEXT CHECK (status IN ('pledged', 'received', 'distributed')) DEFAULT 'pledged',
  delivery_date TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Grid Discussions table
CREATE TABLE IF NOT EXISTS grid_discussions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  grid_id UUID REFERENCES grids(id),
  user_id UUID REFERENCES users(id),
  parent_id UUID REFERENCES grid_discussions(id), -- for threaded discussions
  message TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_disaster_areas_status ON disaster_areas(status);
CREATE INDEX IF NOT EXISTS idx_announcements_published ON announcements(published);
CREATE INDEX IF NOT EXISTS idx_volunteers_status ON volunteers(status);
CREATE INDEX IF NOT EXISTS idx_volunteer_registrations_status ON volunteer_registrations(status);
CREATE INDEX IF NOT EXISTS idx_supply_donations_status ON supply_donations(status);
CREATE INDEX IF NOT EXISTS idx_grid_discussions_grid_id ON grid_discussions(grid_id);

-- Add RLS policies for new tables
ALTER TABLE disaster_areas ENABLE ROW LEVEL SECURITY;
CREATE POLICY disaster_areas_select_all ON disaster_areas FOR SELECT USING (true);

ALTER TABLE announcements ENABLE ROW LEVEL SECURITY;
CREATE POLICY announcements_select_published ON announcements FOR SELECT USING (published = true);

ALTER TABLE volunteers ENABLE ROW LEVEL SECURITY;
CREATE POLICY volunteers_select_all ON volunteers FOR SELECT USING (true);

ALTER TABLE volunteer_registrations ENABLE ROW LEVEL SECURITY;
CREATE POLICY volunteer_registrations_select_own ON volunteer_registrations
  FOR SELECT USING (volunteer_id IN (SELECT id FROM volunteers WHERE user_id = app.current_user_id()));

ALTER TABLE supply_donations ENABLE ROW LEVEL SECURITY;
CREATE POLICY supply_donations_select_all ON supply_donations FOR SELECT USING (true);

ALTER TABLE grid_discussions ENABLE ROW LEVEL SECURITY;
CREATE POLICY grid_discussions_select_all ON grid_discussions FOR SELECT USING (true);

-- Add audit triggers for new tables
CREATE TRIGGER audit_disaster_areas AFTER INSERT OR UPDATE OR DELETE ON disaster_areas
FOR EACH ROW EXECUTE FUNCTION app.audit_trigger();

CREATE TRIGGER audit_announcements AFTER INSERT OR UPDATE OR DELETE ON announcements
FOR EACH ROW EXECUTE FUNCTION app.audit_trigger();

CREATE TRIGGER audit_volunteers AFTER INSERT OR UPDATE OR DELETE ON volunteers
FOR EACH ROW EXECUTE FUNCTION app.audit_trigger();

CREATE TRIGGER audit_volunteer_registrations AFTER INSERT OR UPDATE OR DELETE ON volunteer_registrations
FOR EACH ROW EXECUTE FUNCTION app.audit_trigger();

CREATE TRIGGER audit_supply_donations AFTER INSERT OR UPDATE OR DELETE ON supply_donations
FOR EACH ROW EXECUTE FUNCTION app.audit_trigger();

CREATE TRIGGER audit_grid_discussions AFTER INSERT OR UPDATE OR DELETE ON grid_discussions
FOR EACH ROW EXECUTE FUNCTION app.audit_trigger();

-- Insert some sample data for testing
INSERT INTO disaster_areas (name, description, location, severity, status) VALUES
  ('È¶¨Â§™ÈûçÊ∫™Â†∞Â°ûÊπñ', 'Â†∞Â°ûÊπñÊΩ∞Â†§Â∞éËá¥Âö¥ÈáçÊ∑πÊ∞¥', 'Ëä±ËìÆÁ∏£ÂÖâÂæ©ÈÑâ', 'critical', 'active'),
  ('ÂÖâÂæ©Â∏ÇÂçÄÊ∑πÊ∞¥ÂçÄ', 'Â∏ÇÂçÄ‰ΩéÁ™™Âú∞Â∏∂Ê∑πÊ∞¥', 'Ëä±ËìÆÁ∏£ÂÖâÂæ©ÈÑâÂ∏ÇÂçÄ', 'high', 'monitoring')
ON CONFLICT DO NOTHING;

INSERT INTO announcements (title, content, priority, published) VALUES
  ('ÂøóÂ∑•ÊãõÂãü‰∏≠', 'ÊÄ•ÈúÄÂøóÂ∑•ÂçîÂä©Ê∏ÖÊ∑§Â∑•‰ΩúÔºåË´ãÊúâÊÑèÈ°òËÄÖÂ†±Âêç', 'urgent', true),
  ('Áâ©Ë≥áÈúÄÊ±ÇÂÖ¨Âëä', 'ÁõÆÂâçÈúÄË¶ÅÊ∏ÖÊΩîÁî®ÂÖ∑„ÄÅÈ£≤Áî®Ê∞¥„ÄÅÂç≥È£üÈ£üÂìÅ', 'high', true)
ON CONFLICT DO NOTHING;
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696244400000_create_all_tables', NOW());


### MIGRATION 1696248000000_expand_grids_table (UP) ###
-- Migration 0005: Expand grids table for map functionality
-- Generated: 2025-10-02
-- Purpose: Add all necessary fields for map display and grid management

-- Add new columns to grids table
ALTER TABLE grids
  ADD COLUMN IF NOT EXISTS code TEXT,
  ADD COLUMN IF NOT EXISTS grid_type TEXT CHECK (grid_type IN ('mud_disposal', 'manpower', 'supply_storage', 'accommodation', 'food_area')),
  ADD COLUMN IF NOT EXISTS status TEXT CHECK (status IN ('open', 'closed', 'completed', 'in_progress', 'preparing')) DEFAULT 'preparing',
  ADD COLUMN IF NOT EXISTS center_lat DECIMAL(10, 7),
  ADD COLUMN IF NOT EXISTS center_lng DECIMAL(10, 7),
  ADD COLUMN IF NOT EXISTS bounds JSONB,
  ADD COLUMN IF NOT EXISTS volunteer_needed INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS volunteer_registered INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS supplies_needed JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS meeting_point TEXT,
  ADD COLUMN IF NOT EXISTS description TEXT,
  ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT NOW(),
  ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_grids_status ON grids(status);
CREATE INDEX IF NOT EXISTS idx_grids_grid_type ON grids(grid_type);
CREATE INDEX IF NOT EXISTS idx_grids_location ON grids(center_lat, center_lng);

-- Insert sample grid data for testing (ÂÖâÂæ©Âú∞ÂçÄ)
-- Grid coordinates are around ÂÖâÂæ©ÈÑâ (23.875, 121.578)

INSERT INTO grids (code, name, area_id, grid_type, status, center_lat, center_lng, bounds, volunteer_needed, volunteer_registered, meeting_point, description) VALUES
  -- Manpower grids (‰∫∫Âäõ‰ªªÂãô)
  ('A1', 'ÂÖâÂæ©Â∏ÇÂçÄÊ∏ÖÊ∑§ÂçÄA1', NULL, 'manpower', 'open', 23.8751, 121.5780,
   '{"north": 23.8761, "south": 23.8741, "east": 121.5790, "west": 121.5770}'::jsonb,
   20, 5, 'ÂÖâÂæ©ÈÑâÂÖ¨ÊâÄÂâçÂª£Â†¥', 'Â∏ÇÂçÄ‰∏ªË¶ÅÈÅìË∑ØÊ∏ÖÊ∑§‰ΩúÊ•≠'),

  ('A2', 'ÂÖâÂæ©Â∏ÇÂçÄÊ∏ÖÊ∑§ÂçÄA2', NULL, 'manpower', 'open', 23.8770, 121.5800,
   '{"north": 23.8780, "south": 23.8760, "east": 121.5810, "west": 121.5790}'::jsonb,
   15, 12, 'ÂÖâÂæ©ÂúãÂ∞è', '‰ΩèÂÆÖÂçÄÊ∏ÖÊ∑§‰ΩúÊ•≠'),

  ('A3', 'È¶¨Â§™ÈûçÊ∫™Ê≤øÂ≤∏Ê∏ÖÁêÜ', NULL, 'manpower', 'open', 23.8800, 121.5820,
   '{"north": 23.8810, "south": 23.8790, "east": 121.5830, "west": 121.5810}'::jsonb,
   30, 8, 'È¶¨Â§™ÈûçÊ©ãÈ†≠', 'Ê≤≥Â≤∏Ê∏ÖÁêÜËàáÂûÉÂúæÊ∏ÖÈÅã'),

  ('A4', 'Ëæ≤Áî∞Âæ©ÂéüÂçÄ', NULL, 'manpower', 'in_progress', 23.8730, 121.5760,
   '{"north": 23.8740, "south": 23.8720, "east": 121.5770, "west": 121.5750}'::jsonb,
   25, 20, 'ÂÖâÂæ©Á≥ñÂª†ÂÖ•Âè£', 'Ëæ≤Áî∞Ê∑§Ê≥•Ê∏ÖÁêÜ'),

  ('A5', 'Á§æÂçÄÂ∑∑ÈÅìÊ∏ÖÁêÜ', NULL, 'manpower', 'completed', 23.8720, 121.5790,
   '{"north": 23.8730, "south": 23.8710, "east": 121.5800, "west": 121.5780}'::jsonb,
   10, 10, 'ÂÖâÂæ©Ë°ó45Ëôü', 'Â∑≤ÂÆåÊàêÂ∑∑ÈÅìÊ∏ÖÊ∑§'),

  -- Mud disposal sites (Ê±°Ê≥•Êö´ÁΩÆÂ†¥)
  ('B1', 'ÂÖâÂæ©Êö´ÁΩÆÂ†¥1Ëôü', NULL, 'mud_disposal', 'open', 23.8820, 121.5850,
   '{"north": 23.8830, "south": 23.8810, "east": 121.5860, "west": 121.5840}'::jsonb,
   0, 0, 'Âè∞9Á∑öÊóÅÁ©∫Âú∞', 'ÂèØÂÆπÁ¥çÁ¥Ñ500Á´ãÊñπÂÖ¨Â∞∫'),

  ('B2', 'ÂÖâÂæ©Êö´ÁΩÆÂ†¥2Ëôü', NULL, 'mud_disposal', 'open', 23.8700, 121.5730,
   '{"north": 23.8710, "south": 23.8690, "east": 121.5740, "west": 121.5720}'::jsonb,
   0, 0, 'ÂÖâÂæ©Â∑•Ê•≠ÂçÄ', 'Â§ßÂûãÊ±°Ê≥•Êö´ÁΩÆÂçÄ'),

  -- Supply storage (Áâ©Ë≥áÂÅúÊîæËôï)
  ('C1', 'ÂÖâÂæ©Áâ©Ë≥áÈõÜÊï£‰∏≠ÂøÉ', NULL, 'supply_storage', 'open', 23.8760, 121.5795,
   '{"north": 23.8770, "south": 23.8750, "east": 121.5805, "west": 121.5785}'::jsonb,
   0, 0, 'ÂÖâÂæ©Âúã‰∏≠È´îËÇ≤È§®', 'Áâ©Ë≥áÊé•Êî∂ËàáÂàÜÁôº'),

  ('C2', 'ÂÖâÂæ©Áâ©Ë≥áÁ´ô2Ëôü', NULL, 'supply_storage', 'open', 23.8780, 121.5770,
   '{"north": 23.8790, "south": 23.8770, "east": 121.5780, "west": 121.5760}'::jsonb,
   0, 0, 'ÂÖâÂæ©Á§æÂçÄÊ¥ªÂãï‰∏≠ÂøÉ', 'ÂÇôÁî®Áâ©Ë≥áÁ´ô'),

  -- Accommodation (‰ΩèÂÆøÂú∞Èªû)
  ('D1', 'ÂøóÂ∑•‰ΩèÂÆøÈªû1', NULL, 'accommodation', 'open', 23.8740, 121.5785,
   '{"north": 23.8750, "south": 23.8730, "east": 121.5795, "west": 121.5775}'::jsonb,
   0, 0, 'ÂÖâÂæ©ÂúãÂ∞èÊïôÂÆ§', 'ÂèØÂÆπÁ¥ç50‰∫∫'),

  ('D2', 'ÂøóÂ∑•‰ΩèÂÆøÈªû2', NULL, 'accommodation', 'open', 23.8790, 121.5810,
   '{"north": 23.8800, "south": 23.8780, "east": 121.5820, "west": 121.5800}'::jsonb,
   0, 0, 'ÂÖâÂæ©Ê¥ªÂãï‰∏≠ÂøÉ', 'ÂèØÂÆπÁ¥ç30‰∫∫'),

  -- Food area (È†òÂêÉÈ£üÂçÄÂüü)
  ('E1', 'ÂøóÂ∑•Áî®È§êÂçÄ', NULL, 'food_area', 'open', 23.8755, 121.5782,
   '{"north": 23.8765, "south": 23.8745, "east": 121.5792, "west": 121.5772}'::jsonb,
   0, 0, 'ÂÖâÂæ©ÈÑâÂÖ¨ÊâÄ', 'Êèê‰æõ‰∏âÈ§êËàáÈ£≤Ê∞¥'),

  ('E2', 'ÂÇôÁî®Áî®È§êÂçÄ', NULL, 'food_area', 'open', 23.8775, 121.5805,
   '{"north": 23.8785, "south": 23.8765, "east": 121.5815, "west": 121.5795}'::jsonb,
   0, 0, 'ÂÖâÂæ©ÊïôÊúÉ', 'ÂÇôÁî®È§êÈªû‰æõÊáâÁ´ô')

ON CONFLICT (id) DO NOTHING;

-- Update supplies_needed for supply storage grids
UPDATE grids
SET supplies_needed = '[
  {"name": "Ê∏ÖÊΩîÁî®ÂÖ∑", "quantity": 100, "received": 45, "unit": "ÁµÑ"},
  {"name": "È£≤Áî®Ê∞¥", "quantity": 500, "received": 320, "unit": "Áì∂"},
  {"name": "Âç≥È£üÈ£üÂìÅ", "quantity": 200, "received": 150, "unit": "‰ªΩ"}
]'::jsonb
WHERE grid_type = 'supply_storage';
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696248000000_expand_grids_table', NOW());


### MIGRATION 1696251600000_add_announcement_fields (UP) ###
-- Migration 0006: Add missing fields to announcements table
-- This adds fields that the frontend expects but were missing from the schema

-- Add new columns
ALTER TABLE announcements
  ADD COLUMN IF NOT EXISTS category TEXT DEFAULT 'safety'
    CHECK (category IN ('safety', 'equipment', 'center', 'external', 'contact')),
  ADD COLUMN IF NOT EXISTS is_pinned BOOLEAN DEFAULT FALSE,
  ADD COLUMN IF NOT EXISTS "order" INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS contact_phone TEXT,
  ADD COLUMN IF NOT EXISTS external_links JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS priority TEXT DEFAULT 'normal'
    CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
  ADD COLUMN IF NOT EXISTS published BOOLEAN DEFAULT TRUE;

-- Set default category for existing announcements
UPDATE announcements
SET category = 'center'
WHERE category IS NULL;

-- Create indexes for filtering
CREATE INDEX IF NOT EXISTS idx_announcements_category ON announcements(category);
CREATE INDEX IF NOT EXISTS idx_announcements_pinned ON announcements(is_pinned);
CREATE INDEX IF NOT EXISTS idx_announcements_published ON announcements(published);
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696251600000_add_announcement_fields', NOW());


### MIGRATION 1696255200000_add_volunteer_registration_statuses (UP) ###
-- Migration 0008: Add 'arrived' and 'completed' statuses to volunteer_registrations
-- Generated: 2025-10-02

-- Drop the existing CHECK constraint
ALTER TABLE volunteer_registrations
DROP CONSTRAINT IF EXISTS volunteer_registrations_status_check;

-- Add new CHECK constraint with all status values
ALTER TABLE volunteer_registrations
ADD CONSTRAINT volunteer_registrations_status_check
CHECK (status IN ('pending', 'confirmed', 'arrived', 'completed', 'cancelled'));

-- Add updated_at column if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT FROM information_schema.columns
    WHERE table_name = 'volunteer_registrations' AND column_name = 'updated_at'
  ) THEN
    ALTER TABLE volunteer_registrations
    ADD COLUMN updated_at TIMESTAMPTZ DEFAULT NOW();
  END IF;
END $$;

-- Create trigger to auto-update updated_at timestamp
CREATE OR REPLACE FUNCTION update_volunteer_registrations_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS volunteer_registrations_updated_at ON volunteer_registrations;
CREATE TRIGGER volunteer_registrations_updated_at
  BEFORE UPDATE ON volunteer_registrations
  FOR EACH ROW
  EXECUTE FUNCTION update_volunteer_registrations_updated_at();

-- Add RLS policy for UPDATE operations
-- Users can update their own registrations OR admins can update any
-- Note: Simplified version without app.is_admin() function - will be added in auth migration
DROP POLICY IF EXISTS volunteer_registrations_update_own ON volunteer_registrations;
CREATE POLICY volunteer_registrations_update_own ON volunteer_registrations
  FOR UPDATE
  USING (
    volunteer_id IN (SELECT id FROM volunteers WHERE user_id = app.current_user_id())
  )
  WITH CHECK (
    volunteer_id IN (SELECT id FROM volunteers WHERE user_id = app.current_user_id())
  );

-- Add comment for documentation
COMMENT ON CONSTRAINT volunteer_registrations_status_check ON volunteer_registrations IS
'Valid status values: pending (initial), confirmed (admin approved), arrived (checked in), completed (task done), cancelled (user or admin cancelled)';
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696255200000_add_volunteer_registration_statuses', NOW());


### MIGRATION 1696258800000_add_grid_manager_column (UP) ###
-- Migration 0010: Add grid_manager_id to grids table
-- Purpose: Support RBAC for grid managers to view volunteer phone numbers
-- Created: 2025-10-03

-- Add grid_manager_id column to grids table
ALTER TABLE grids
  ADD COLUMN IF NOT EXISTS grid_manager_id UUID REFERENCES users(id) ON DELETE SET NULL;

-- Create index for better query performance
CREATE INDEX IF NOT EXISTS idx_grids_manager ON grids(grid_manager_id);

-- Add comment for documentation
COMMENT ON COLUMN grids.grid_manager_id IS 'User ID of the grid manager (ngo_coordinator role) who can view volunteer phone numbers for this grid';
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696258800000_add_grid_manager_column', NOW());


### MIGRATION 1696262400000_create_auth_system (UP) ###
-- ============================================
-- ÈèüÂ≠êËã±ÈõÑ - Ë™çË≠âÁ≥ªÁµ±Ë≥áÊñôÂ∫´ Schema
-- Migration: 0011_create_auth_system
-- Created: 2025-10-02
-- Description: ALTER existing users table + create auth tables
-- ============================================

-- ÂïüÁî®ÂøÖË¶ÅÁöÑÊì¥ÂÖÖÂäüËÉΩ
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================
-- 1. Êõ¥Êñ∞ÁèæÊúâ users Ë°®
-- ============================================

-- Êñ∞Â¢ûË™çË≠âÊ¨Ñ‰Ωç
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone_number VARCHAR(20) UNIQUE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS email VARCHAR(255) UNIQUE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_hash VARCHAR(255);

-- Êñ∞Â¢ûËßíËâ≤ËàáÁãÄÊÖã
ALTER TABLE users ADD COLUMN IF NOT EXISTS role VARCHAR(20) CHECK (role IN ('volunteer', 'victim', 'ngo_coordinator', 'regional_admin', 'data_analyst', 'super_admin'));
ALTER TABLE users ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'pending_verification', 'inactive'));

-- ÂÄãË≥áÊ¨Ñ‰ΩçÔºàÂä†ÂØÜÂ≠òÂÑ≤Ôºâ
ALTER TABLE users ADD COLUMN IF NOT EXISTS full_name_encrypted BYTEA;
ALTER TABLE users ADD COLUMN IF NOT EXISTS emergency_contact_encrypted BYTEA;

-- È©óË≠âÁãÄÊÖã
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS email_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS identity_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS verified_by UUID REFERENCES users(id);
ALTER TABLE users ADD COLUMN IF NOT EXISTS verified_at TIMESTAMP WITH TIME ZONE;

-- ÈõôÂõ†Á¥†Ë™çË≠â
ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_secret VARCHAR(255);
ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS backup_codes TEXT[];

-- ÁôªÂÖ•ÂÆâÂÖ®
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_login_ip INET;
ALTER TABLE users ADD COLUMN IF NOT EXISTS failed_login_attempts INT DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS locked_until TIMESTAMP WITH TIME ZONE;

-- ÊôÇÈñìÊà≥Ë®ò
ALTER TABLE users ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE users ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Á¥¢ÂºïÂÑ™Âåñ
CREATE INDEX IF NOT EXISTS idx_users_phone ON users(phone_number) WHERE phone_number IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
CREATE INDEX IF NOT EXISTS idx_users_status ON users(status);

-- Ëá™ÂãïÊõ¥Êñ∞ updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 2. ÂøóÂ∑•ÂÄã‰∫∫Ê™îÊ°à
-- ============================================

CREATE TABLE IF NOT EXISTS volunteer_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  skills TEXT[] DEFAULT '{}',
  organization VARCHAR(255),
  total_hours DECIMAL(10,2) DEFAULT 0,
  total_tasks INT DEFAULT 0,
  completed_tasks INT DEFAULT 0,
  rating DECIMAL(3,2),
  review_count INT DEFAULT 0,
  preferred_areas TEXT[],
  availability JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_volunteer_skills ON volunteer_profiles USING GIN(skills);
CREATE INDEX IF NOT EXISTS idx_volunteer_organization ON volunteer_profiles(organization);

DROP TRIGGER IF EXISTS update_volunteer_profiles_updated_at ON volunteer_profiles;
CREATE TRIGGER update_volunteer_profiles_updated_at
  BEFORE UPDATE ON volunteer_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 3. ÂèóÁÅΩÊà∂ÂÄã‰∫∫Ê™îÊ°à
-- ============================================

CREATE TABLE IF NOT EXISTS victim_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  address_encrypted BYTEA,
  latitude DECIMAL(10,8),
  longitude DECIMAL(11,8),
  damage_description TEXT,
  damage_level VARCHAR(20) CHECK (damage_level IN ('minor', 'moderate', 'severe', 'critical')),
  damage_photos TEXT[],
  verification_status VARCHAR(20) DEFAULT 'pending' CHECK (verification_status IN ('pending', 'approved', 'rejected', 'need_more_info')),
  verification_notes TEXT,
  reviewed_by UUID REFERENCES users(id),
  reviewed_at TIMESTAMP WITH TIME ZONE,
  needs_met BOOLEAN DEFAULT FALSE,
  priority_level INT DEFAULT 3 CHECK (priority_level BETWEEN 1 AND 5),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_victim_status ON victim_profiles(verification_status);
CREATE INDEX IF NOT EXISTS idx_victim_priority ON victim_profiles(priority_level);
CREATE INDEX IF NOT EXISTS idx_victim_location ON victim_profiles(latitude, longitude);

DROP TRIGGER IF EXISTS update_victim_profiles_updated_at ON victim_profiles;
CREATE TRIGGER update_victim_profiles_updated_at
  BEFORE UPDATE ON victim_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 4. OTP È©óË≠âÁ¢ºÁÆ°ÁêÜ
-- ============================================

CREATE TABLE IF NOT EXISTS otp_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  identifier VARCHAR(255) NOT NULL,
  code_hash VARCHAR(255) NOT NULL,
  purpose VARCHAR(50) NOT NULL CHECK (purpose IN ('login', 'reset_password', '2fa', 'phone_verification', 'email_verification')),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  used_at TIMESTAMP WITH TIME ZONE,
  attempts INT DEFAULT 0,
  max_attempts INT DEFAULT 5,
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_otp_identifier ON otp_codes(identifier, purpose, expires_at);
CREATE INDEX IF NOT EXISTS idx_otp_expires ON otp_codes(expires_at);

-- ============================================
-- 5. Session ÁÆ°ÁêÜ
-- ============================================

CREATE TABLE IF NOT EXISTS sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash VARCHAR(255) NOT NULL UNIQUE,
  refresh_token_hash VARCHAR(255) UNIQUE,
  ip_address INET,
  user_agent TEXT,
  device_fingerprint VARCHAR(255),
  device_trusted BOOLEAN DEFAULT FALSE,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  refresh_expires_at TIMESTAMP WITH TIME ZONE,
  last_activity_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_sessions_user ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_token ON sessions(token_hash);
CREATE INDEX IF NOT EXISTS idx_sessions_expires ON sessions(expires_at);

-- ============================================
-- 6. Ê¨äÈôêÁÆ°ÁêÜ
-- ============================================

CREATE TABLE IF NOT EXISTS permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL UNIQUE,
  description TEXT,
  resource_type VARCHAR(50),
  action VARCHAR(50),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS role_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role VARCHAR(20) NOT NULL,
  permission_id UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(role, permission_id)
);

CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON role_permissions(role);

CREATE TABLE IF NOT EXISTS user_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  permission_id UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  granted BOOLEAN DEFAULT TRUE,
  granted_by UUID REFERENCES users(id),
  granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(user_id, permission_id)
);

CREATE INDEX IF NOT EXISTS idx_user_permissions_user ON user_permissions(user_id);

-- ============================================
-- 7. Á®ΩÊ†∏Êó•Ë™å
-- ============================================

CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  user_role VARCHAR(20),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id UUID,
  old_value JSONB,
  new_value JSONB,
  ip_address INET,
  user_agent TEXT,
  request_method VARCHAR(10),
  request_path TEXT,
  request_data JSONB,
  response_status INT,
  is_suspicious BOOLEAN DEFAULT FALSE,
  risk_level VARCHAR(20) CHECK (risk_level IN ('low', 'medium', 'high', 'critical')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_audit_logs_user ON audit_logs(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs(action, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX IF NOT EXISTS idx_audit_logs_suspicious ON audit_logs(is_suspicious) WHERE is_suspicious = TRUE;
CREATE INDEX IF NOT EXISTS idx_audit_logs_created ON audit_logs(created_at DESC);

-- ============================================
-- 8. ÁôªÂÖ•Ê≠∑Âè≤Ë®òÈåÑ
-- ============================================

CREATE TABLE IF NOT EXISTS login_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  success BOOLEAN NOT NULL,
  failure_reason VARCHAR(100),
  ip_address INET,
  user_agent TEXT,
  device_type VARCHAR(50),
  browser VARCHAR(50),
  os VARCHAR(50),
  location_country VARCHAR(2),
  location_city VARCHAR(100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_login_history_user ON login_history(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_login_history_ip ON login_history(ip_address);
CREATE INDEX IF NOT EXISTS idx_login_history_failed ON login_history(success) WHERE success = FALSE;

-- ============================================
-- 9. È†êË®≠Ê¨äÈôêË≥áÊñô
-- ============================================

INSERT INTO permissions (name, description, resource_type, action) VALUES
  ('view_own_profile', 'Êü•ÁúãËá™Â∑±ÁöÑÂÄã‰∫∫Ë≥áÊñô', 'volunteer', 'read'),
  ('update_own_profile', 'Êõ¥Êñ∞Ëá™Â∑±ÁöÑÂÄã‰∫∫Ë≥áÊñô', 'volunteer', 'update'),
  ('view_tasks', 'Êü•Áúã‰ªªÂãôÂàóË°®', 'task', 'read'),
  ('accept_task', 'Êé•Âèó‰ªªÂãô', 'task', 'update'),
  ('upload_task_photo', '‰∏äÂÇ≥‰ªªÂãôÁÖßÁâá', 'task', 'create'),
  ('create_help_request', 'Âª∫Á´ãÊïëÊè¥Ë´ãÊ±Ç', 'help_request', 'create'),
  ('view_own_requests', 'Êü•ÁúãËá™Â∑±ÁöÑË´ãÊ±Ç', 'help_request', 'read'),
  ('update_own_request', 'Êõ¥Êñ∞Ëá™Â∑±ÁöÑË´ãÊ±Ç', 'help_request', 'update'),
  ('view_all_volunteers', 'Êü•ÁúãÊâÄÊúâÂøóÂ∑•', 'volunteer', 'read'),
  ('assign_tasks', 'ÂàÜÈÖç‰ªªÂãô', 'task', 'create'),
  ('update_tasks', 'Êõ¥Êñ∞‰ªªÂãôÁãÄÊÖã', 'task', 'update'),
  ('view_all_requests', 'Êü•ÁúãÊâÄÊúâÊïëÊè¥Ë´ãÊ±Ç', 'help_request', 'read'),
  ('approve_victim', 'ÂØ©Ê†∏ÂèóÁÅΩÊà∂', 'victim', 'update'),
  ('manage_users', 'ÁÆ°ÁêÜ‰ΩøÁî®ËÄÖ', 'user', '*'),
  ('view_audit_logs', 'Êü•ÁúãÁ®ΩÊ†∏Êó•Ë™å', 'audit', 'read'),
  ('manage_permissions', 'ÁÆ°ÁêÜÊ¨äÈôê', 'permission', '*'),
  ('export_data', 'ÂåØÂá∫Ë≥áÊñô', 'data', 'read')
ON CONFLICT (name) DO NOTHING;

-- ËßíËâ≤È†êË®≠Ê¨äÈôê
INSERT INTO role_permissions (role, permission_id)
SELECT 'volunteer', id FROM permissions WHERE name IN (
  'view_own_profile', 'update_own_profile', 'view_tasks', 'accept_task', 'upload_task_photo'
)
ON CONFLICT DO NOTHING;

INSERT INTO role_permissions (role, permission_id)
SELECT 'victim', id FROM permissions WHERE name IN (
  'view_own_profile', 'update_own_profile', 'create_help_request', 'view_own_requests', 'update_own_request'
)
ON CONFLICT DO NOTHING;

INSERT INTO role_permissions (role, permission_id)
SELECT 'ngo_coordinator', id FROM permissions WHERE name IN (
  'view_own_profile', 'update_own_profile',
  'view_all_volunteers', 'assign_tasks', 'update_tasks',
  'view_all_requests', 'approve_victim'
)
ON CONFLICT DO NOTHING;

INSERT INTO role_permissions (role, permission_id)
SELECT 'super_admin', id FROM permissions
ON CONFLICT DO NOTHING;

-- ============================================
-- 10. RLS (Row Level Security) ÊîøÁ≠ñ
-- ============================================

ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE volunteer_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE victim_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- ‰ΩøÁî®ËÄÖÂè™ËÉΩÊü•ÁúãËá™Â∑±ÁöÑË≥áÊñô
DROP POLICY IF EXISTS users_self_access ON users;
CREATE POLICY users_self_access ON users
  FOR SELECT
  USING (id = current_setting('app.user_id', true)::UUID);

-- ÁÆ°ÁêÜÂì°ÂèØ‰ª•Êü•ÁúãÊâÄÊúâ‰ΩøÁî®ËÄÖ
DROP POLICY IF EXISTS users_admin_access ON users;
CREATE POLICY users_admin_access ON users
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = current_setting('app.user_id', true)::UUID
      AND u.role IN ('super_admin', 'ngo_coordinator')
    )
  );

-- ÂøóÂ∑•Âè™ËÉΩÊü•ÁúãËá™Â∑±ÁöÑ profile
DROP POLICY IF EXISTS volunteer_self_access ON volunteer_profiles;
CREATE POLICY volunteer_self_access ON volunteer_profiles
  FOR ALL
  USING (user_id = current_setting('app.user_id', true)::UUID);

-- NGO ÂçîË™øËÄÖÂèØ‰ª•Êü•ÁúãÊâÄÊúâÂøóÂ∑• profile
DROP POLICY IF EXISTS volunteer_ngo_access ON volunteer_profiles;
CREATE POLICY volunteer_ngo_access ON volunteer_profiles
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = current_setting('app.user_id', true)::UUID
      AND u.role IN ('ngo_coordinator', 'super_admin')
    )
  );

-- ============================================
-- 11. ËºîÂä©ÂáΩÊï∏
-- ============================================

CREATE OR REPLACE FUNCTION encrypt_pii(plaintext TEXT, secret TEXT DEFAULT 'your-secret-key')
RETURNS BYTEA AS $$
BEGIN
  RETURN pgp_sym_encrypt(plaintext, secret);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION decrypt_pii(ciphertext BYTEA, secret TEXT DEFAULT 'your-secret-key')
RETURNS TEXT AS $$
BEGIN
  RETURN pgp_sym_decrypt(ciphertext, secret);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION user_has_permission(
  p_user_id UUID,
  p_permission_name VARCHAR
)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM users u
    LEFT JOIN role_permissions rp ON rp.role = u.role
    LEFT JOIN permissions p ON p.id = rp.permission_id
    LEFT JOIN user_permissions up ON up.user_id = u.id AND up.permission_id = p.id
    WHERE u.id = p_user_id
    AND p.name = p_permission_name
    AND (up.granted IS NULL OR up.granted = TRUE)
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696262400000_create_auth_system', NOW());


### MIGRATION 1696266000000_add_grid_code_unique_constraint (UP) ###
-- Migration 0012: Add UNIQUE constraint to grids.code
-- Generated: 2025-10-02
-- Purpose: Ensure grid codes are unique for conflict detection

-- Add UNIQUE constraint to code field
-- This will enable proper 409 Conflict responses when duplicate codes are submitted
ALTER TABLE grids
  ADD CONSTRAINT grids_code_key UNIQUE (code);

-- Create index for code lookups (automatically created by UNIQUE constraint, but explicit for clarity)
-- CREATE UNIQUE INDEX IF NOT EXISTS idx_grids_code ON grids(code);
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696266000000_add_grid_code_unique_constraint', NOW());


### MIGRATION 1696269600000_auto_update_volunteer_count (UP) ###
-- Migration 0013: Ëá™ÂãïÊõ¥Êñ∞Á∂≤Ê†ºÂøóÂ∑•‰∫∫Êï∏
-- Description: Áï∂ÂøóÂ∑•Â†±ÂêçÊàñÂèñÊ∂àÊôÇÔºåËá™ÂãïÂ¢ûÊ∏õ grids.volunteer_registered
-- Created: 2025-10-02

-- Âª∫Á´ãËß∏ÁôºÂáΩÊï∏
CREATE OR REPLACE FUNCTION update_grid_volunteer_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    -- Êñ∞Â¢ûÂ†±ÂêçÔºövolunteer_registered +1
    UPDATE grids
    SET volunteer_registered = volunteer_registered + 1,
        updated_at = NOW()
    WHERE id = NEW.grid_id;
    RETURN NEW;

  ELSIF TG_OP = 'DELETE' THEN
    -- ÂèñÊ∂àÂ†±ÂêçÔºövolunteer_registered -1Ôºà‰∏çÂ∞èÊñº0Ôºâ
    UPDATE grids
    SET volunteer_registered = GREATEST(0, volunteer_registered - 1),
        updated_at = NOW()
    WHERE id = OLD.grid_id;
    RETURN OLD;

  ELSIF TG_OP = 'UPDATE' THEN
    -- Â¶ÇÊûú grid_id ÊîπËÆäÔºàÁΩïË¶ãÊÉÖÊ≥ÅÔºâ
    IF OLD.grid_id != NEW.grid_id THEN
      -- ËàäÁ∂≤Ê†º -1
      UPDATE grids
      SET volunteer_registered = GREATEST(0, volunteer_registered - 1),
          updated_at = NOW()
      WHERE id = OLD.grid_id;

      -- Êñ∞Á∂≤Ê†º +1
      UPDATE grids
      SET volunteer_registered = volunteer_registered + 1,
          updated_at = NOW()
      WHERE id = NEW.grid_id;
    END IF;
    RETURN NEW;
  END IF;

  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- Âª∫Á´ãËß∏ÁôºÂô®
DROP TRIGGER IF EXISTS trg_volunteer_registration_count ON volunteer_registrations;

CREATE TRIGGER trg_volunteer_registration_count
AFTER INSERT OR DELETE OR UPDATE OF grid_id ON volunteer_registrations
FOR EACH ROW
EXECUTE FUNCTION update_grid_volunteer_count();

-- È©óË≠âÁèæÊúâË≥áÊñôÁöÑË®àÊï∏Ê≠£Á¢∫ÊÄßÔºà‰∏ÄÊ¨°ÊÄß‰øÆÂæ©Ôºâ
UPDATE grids g
SET volunteer_registered = (
  SELECT COUNT(*)
  FROM volunteer_registrations vr
  WHERE vr.grid_id = g.id
);

-- È©óË≠âËß∏ÁôºÂô®ÂÆâË£ùÊàêÂäü
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM pg_trigger
    WHERE tgname = 'trg_volunteer_registration_count'
  ) THEN
    RAISE NOTICE 'Trigger trg_volunteer_registration_count created successfully';
  ELSE
    RAISE EXCEPTION 'Failed to create trigger trg_volunteer_registration_count';
  END IF;
END $$;
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696269600000_auto_update_volunteer_count', NOW());


### MIGRATION 1696273200000_complete_rls_policies (UP) ###
-- ============================================
-- Migration 0009: Comprehensive RLS Policies
-- Created: 2025-10-02
-- Description: Complete Row-Level Security policies for all tables
-- ============================================
--
-- This migration establishes comprehensive RLS policies across all tables
-- following role-based access control principles:
--   - volunteer: Basic user with task access
--   - victim: Request help and view own data
--   - ngo_coordinator: Manage volunteers and tasks
--   - regional_admin: Regional oversight and management
--   - data_analyst: Read-only analytics access
--   - super_admin: Full system access
-- ============================================

-- ============================================
-- Helper Functions
-- ============================================

-- Function to check if user has one of the required roles
CREATE OR REPLACE FUNCTION user_has_role(required_roles TEXT[])
RETURNS BOOLEAN AS $$
DECLARE
  current_user_id UUID;
  current_user_role TEXT;
BEGIN
  -- Get current user ID from session context
  BEGIN
    current_user_id := current_setting('app.user_id', true)::UUID;
  EXCEPTION WHEN OTHERS THEN
    RETURN FALSE;
  END;

  -- Return false if no user context
  IF current_user_id IS NULL THEN
    RETURN FALSE;
  END IF;

  -- Get user role
  SELECT role INTO current_user_role
  FROM users
  WHERE id = current_user_id;

  -- Check if user role is in required roles
  RETURN current_user_role = ANY(required_roles);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- Function to get current user ID safely
CREATE OR REPLACE FUNCTION get_current_user_id()
RETURNS UUID AS $$
BEGIN
  RETURN current_setting('app.user_id', true)::UUID;
EXCEPTION WHEN OTHERS THEN
  RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- Function to check if user is admin (coordinator or above)
CREATE OR REPLACE FUNCTION is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin']);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- ============================================
-- 1. GRIDS Table Policies
-- ============================================

-- Drop existing overly permissive policy
DROP POLICY IF EXISTS grids_select_all ON grids;

-- Enable RLS
ALTER TABLE grids ENABLE ROW LEVEL SECURITY;

-- SELECT: Everyone can view grids (public map data)
CREATE POLICY grids_select_public ON grids
  FOR SELECT
  USING (true);

-- INSERT: Only coordinators and admins
CREATE POLICY grids_insert_admin ON grids
  FOR INSERT
  WITH CHECK (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- UPDATE: Only coordinators and admins
CREATE POLICY grids_update_admin ON grids
  FOR UPDATE
  USING (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY grids_delete_super_admin ON grids
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 2. ANNOUNCEMENTS Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE announcements ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS announcements_select_published ON announcements;

-- SELECT: Everyone can view published announcements
CREATE POLICY announcements_select_public ON announcements
  FOR SELECT
  USING (published = true OR is_admin());

-- INSERT: Only coordinators and admins can create
CREATE POLICY announcements_insert_admin ON announcements
  FOR INSERT
  WITH CHECK (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- UPDATE: Author or admins can update
CREATE POLICY announcements_update_author_or_admin ON announcements
  FOR UPDATE
  USING (
    author_id = get_current_user_id() OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Author or super admin can delete
CREATE POLICY announcements_delete_author_or_super_admin ON announcements
  FOR DELETE
  USING (
    author_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 3. VOLUNTEERS Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE volunteers ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS volunteers_select_all ON volunteers;

-- SELECT: Self or coordinators/admins
CREATE POLICY volunteers_select_self_or_admin ON volunteers
  FOR SELECT
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin', 'data_analyst'])
  );

-- INSERT: Only self (authenticated users can register as volunteers)
CREATE POLICY volunteers_insert_self ON volunteers
  FOR INSERT
  WITH CHECK (
    user_id = get_current_user_id()
  );

-- UPDATE: Only self can update own profile
CREATE POLICY volunteers_update_self ON volunteers
  FOR UPDATE
  USING (
    user_id = get_current_user_id()
  );

-- DELETE: Self or super admin
CREATE POLICY volunteers_delete_self_or_super_admin ON volunteers
  FOR DELETE
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 4. VOLUNTEER_REGISTRATIONS Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE volunteer_registrations ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS volunteer_registrations_select_own ON volunteer_registrations;

-- SELECT: Volunteer (own registrations) or coordinators
CREATE POLICY volunteer_registrations_select_own_or_admin ON volunteer_registrations
  FOR SELECT
  USING (
    volunteer_id IN (
      SELECT id FROM volunteers WHERE user_id = get_current_user_id()
    ) OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin', 'data_analyst'])
  );

-- INSERT: Volunteers can register themselves
CREATE POLICY volunteer_registrations_insert_own ON volunteer_registrations
  FOR INSERT
  WITH CHECK (
    volunteer_id IN (
      SELECT id FROM volunteers WHERE user_id = get_current_user_id()
    )
  );

-- UPDATE: Volunteer (own, if pending) or coordinators (to approve/reject)
CREATE POLICY volunteer_registrations_update_own_or_admin ON volunteer_registrations
  FOR UPDATE
  USING (
    (
      volunteer_id IN (
        SELECT id FROM volunteers WHERE user_id = get_current_user_id()
      ) AND status = 'pending'
    ) OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Volunteer (own pending registrations) or super admin
CREATE POLICY volunteer_registrations_delete_own_or_super_admin ON volunteer_registrations
  FOR DELETE
  USING (
    (
      volunteer_id IN (
        SELECT id FROM volunteers WHERE user_id = get_current_user_id()
      ) AND status = 'pending'
    ) OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 5. DISASTER_AREAS Table Policies
-- ============================================

-- Enable RLS (already enabled in 0004, but ensure it)
ALTER TABLE disaster_areas ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS disaster_areas_select_all ON disaster_areas;

-- SELECT: Everyone can view disaster areas (public safety info)
CREATE POLICY disaster_areas_select_public ON disaster_areas
  FOR SELECT
  USING (true);

-- INSERT: Only coordinators and admins
CREATE POLICY disaster_areas_insert_admin ON disaster_areas
  FOR INSERT
  WITH CHECK (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- UPDATE: Only coordinators and admins
CREATE POLICY disaster_areas_update_admin ON disaster_areas
  FOR UPDATE
  USING (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY disaster_areas_delete_super_admin ON disaster_areas
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 6. SUPPLY_DONATIONS Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE supply_donations ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS supply_donations_select_all ON supply_donations;

-- SELECT: Everyone can view donations (public transparency)
CREATE POLICY supply_donations_select_public ON supply_donations
  FOR SELECT
  USING (true);

-- INSERT: Anyone authenticated can donate
CREATE POLICY supply_donations_insert_authenticated ON supply_donations
  FOR INSERT
  WITH CHECK (
    get_current_user_id() IS NOT NULL
  );

-- UPDATE: Creator (via donor_contact matching user email) or coordinators
-- Note: This is a simplified check. In production, you'd track creator_id separately
CREATE POLICY supply_donations_update_admin ON supply_donations
  FOR UPDATE
  USING (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY supply_donations_delete_super_admin ON supply_donations
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 7. GRID_DISCUSSIONS Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE grid_discussions ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS grid_discussions_select_all ON grid_discussions;

-- SELECT: Everyone can view discussions (public forum)
CREATE POLICY grid_discussions_select_public ON grid_discussions
  FOR SELECT
  USING (true);

-- INSERT: Anyone authenticated can post
CREATE POLICY grid_discussions_insert_authenticated ON grid_discussions
  FOR INSERT
  WITH CHECK (
    get_current_user_id() IS NOT NULL AND
    user_id = get_current_user_id()
  );

-- UPDATE: Only author can update own messages
CREATE POLICY grid_discussions_update_author ON grid_discussions
  FOR UPDATE
  USING (
    user_id = get_current_user_id()
  );

-- DELETE: Author or super admin
CREATE POLICY grid_discussions_delete_author_or_super_admin ON grid_discussions
  FOR DELETE
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 8. OTP_CODES Table Policies
-- ============================================
-- OTP codes should have strict access control

-- Enable RLS
ALTER TABLE otp_codes ENABLE ROW LEVEL SECURITY;

-- SELECT: Only system (no direct user access)
-- This prevents users from reading OTP codes directly
CREATE POLICY otp_codes_no_select ON otp_codes
  FOR SELECT
  USING (false);

-- INSERT: Only through authentication system
-- In practice, this will be handled by SECURITY DEFINER functions
CREATE POLICY otp_codes_no_direct_insert ON otp_codes
  FOR INSERT
  WITH CHECK (false);

-- UPDATE: Only through authentication system
CREATE POLICY otp_codes_no_update ON otp_codes
  FOR UPDATE
  USING (false);

-- DELETE: Only super admin for cleanup
CREATE POLICY otp_codes_delete_super_admin ON otp_codes
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 9. LOGIN_HISTORY Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE login_history ENABLE ROW LEVEL SECURITY;

-- SELECT: Users can view own login history, admins can view all
CREATE POLICY login_history_select_self_or_admin ON login_history
  FOR SELECT
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin', 'regional_admin'])
  );

-- INSERT: Only through authentication system (SECURITY DEFINER functions)
CREATE POLICY login_history_no_direct_insert ON login_history
  FOR INSERT
  WITH CHECK (false);

-- UPDATE: No updates allowed
CREATE POLICY login_history_no_update ON login_history
  FOR UPDATE
  USING (false);

-- DELETE: Only super admin for data retention
CREATE POLICY login_history_delete_super_admin ON login_history
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 10. PERMISSIONS and ROLE_PERMISSIONS Tables
-- ============================================

-- Enable RLS on permissions table
ALTER TABLE permissions ENABLE ROW LEVEL SECURITY;

-- SELECT: Everyone can view available permissions
CREATE POLICY permissions_select_all ON permissions
  FOR SELECT
  USING (true);

-- INSERT/UPDATE/DELETE: Only super admin
CREATE POLICY permissions_modify_super_admin ON permissions
  FOR ALL
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- Enable RLS on role_permissions table
ALTER TABLE role_permissions ENABLE ROW LEVEL SECURITY;

-- SELECT: Everyone can view role permissions mapping
CREATE POLICY role_permissions_select_all ON role_permissions
  FOR SELECT
  USING (true);

-- INSERT/UPDATE/DELETE: Only super admin
CREATE POLICY role_permissions_modify_super_admin ON role_permissions
  FOR ALL
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- 11. USER_PERMISSIONS Table Policies
-- ============================================

-- Enable RLS
ALTER TABLE user_permissions ENABLE ROW LEVEL SECURITY;

-- SELECT: Users can view own permissions, admins can view all
CREATE POLICY user_permissions_select_self_or_admin ON user_permissions
  FOR SELECT
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin', 'regional_admin'])
  );

-- INSERT/UPDATE/DELETE: Only super admin can manage user permissions
CREATE POLICY user_permissions_modify_super_admin ON user_permissions
  FOR ALL
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- End of Migration 0009
-- ============================================

-- Grant execute permissions on helper functions to authenticated users
GRANT EXECUTE ON FUNCTION user_has_role(TEXT[]) TO PUBLIC;
GRANT EXECUTE ON FUNCTION get_current_user_id() TO PUBLIC;
GRANT EXECUTE ON FUNCTION is_admin() TO PUBLIC;

-- Create index on users.role for faster role checks
CREATE INDEX IF NOT EXISTS idx_users_role_lookup ON users(role) WHERE role IS NOT NULL;

-- Add comment documenting the RLS policy structure
COMMENT ON FUNCTION user_has_role IS 'Check if current user has one of the specified roles. Used in RLS policies.';
COMMENT ON FUNCTION get_current_user_id IS 'Safely get current user ID from app.user_id session variable.';
COMMENT ON FUNCTION is_admin IS 'Check if current user is an admin (coordinator or above).';
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696273200000_complete_rls_policies', NOW());


### MIGRATION 1696276800000_add_missing_columns (UP) ###
-- Migration 0013: Add missing columns to align with BACKEND_API_INTEGRATION_GUIDE.md
-- Purpose: Add contact_info, risks_notes to grids table and volunteer fields to volunteer_registrations
-- Created: 2025-10-03
-- Reference: BACKEND_API_INTEGRATION_GUIDE.md lines 850-878

-- ============================================================================
-- GRIDS TABLE: Add contact and risk information
-- ============================================================================

-- Add contact_info column (sensitive data for grid coordinators)
ALTER TABLE grids
  ADD COLUMN IF NOT EXISTS contact_info VARCHAR(255);

-- Add risks_notes column for safety information
ALTER TABLE grids
  ADD COLUMN IF NOT EXISTS risks_notes TEXT;

-- Add comments for documentation
COMMENT ON COLUMN grids.contact_info IS 'Contact information for grid coordinators - SENSITIVE DATA';
COMMENT ON COLUMN grids.risks_notes IS 'Risk notes and safety information for the grid location';

-- ============================================================================
-- VOLUNTEER_REGISTRATIONS TABLE: Add volunteer-specific fields
-- ============================================================================

-- Add volunteer_name column (if not exists)
ALTER TABLE volunteer_registrations
  ADD COLUMN IF NOT EXISTS volunteer_name VARCHAR(255);

-- Add volunteer_phone column (sensitive data)
ALTER TABLE volunteer_registrations
  ADD COLUMN IF NOT EXISTS volunteer_phone VARCHAR(50);

-- Add available_time column for volunteer availability
ALTER TABLE volunteer_registrations
  ADD COLUMN IF NOT EXISTS available_time TEXT;

-- Add skills array column
ALTER TABLE volunteer_registrations
  ADD COLUMN IF NOT EXISTS skills TEXT[];

-- Add equipment array column
ALTER TABLE volunteer_registrations
  ADD COLUMN IF NOT EXISTS equipment TEXT[];

-- Add comments for documentation
COMMENT ON COLUMN volunteer_registrations.volunteer_name IS 'Name of the volunteer (may differ from user display_name)';
COMMENT ON COLUMN volunteer_registrations.volunteer_phone IS 'Volunteer phone number - SENSITIVE DATA, only visible to grid managers';
COMMENT ON COLUMN volunteer_registrations.available_time IS 'Time availability for volunteer work (e.g., "ÈÄ±Êú´ÂÖ®Â§©", "Âπ≥Êó•Êôö‰∏ä")';
COMMENT ON COLUMN volunteer_registrations.skills IS 'Array of volunteer skills (e.g., ["ÈáçÊ©üÊ¢∞Êìç‰Ωú", "ÈÜ´ÁôÇ", "ÁÉπÈ£™"])';
COMMENT ON COLUMN volunteer_registrations.equipment IS 'Array of equipment volunteer can bring (e.g., ["ÈèüÂ≠ê", "ÊâãÂ•ó", "Ê∞¥Ê°∂"])';

-- ============================================================================
-- INDEXES: Create indexes for better query performance
-- ============================================================================

-- No additional indexes needed for these text/array columns
-- Array columns support GIN indexes if needed in the future:
-- CREATE INDEX IF NOT EXISTS idx_volunteer_registrations_skills ON volunteer_registrations USING GIN (skills);
-- CREATE INDEX IF NOT EXISTS idx_volunteer_registrations_equipment ON volunteer_registrations USING GIN (equipment);

-- ============================================================================
-- RLS POLICIES: Update policies for sensitive data
-- ============================================================================

-- Note: RLS policies for grids.contact_info should be added in 0012_complete_rls_policies.sql
-- Grid managers (ngo_coordinator role) should be able to view contact_info for their assigned grids

-- Note: RLS policies for volunteer_registrations.volunteer_phone should be added in 0012_complete_rls_policies.sql
-- Only grid managers can view volunteer phone numbers for their assigned grids

-- ============================================================================
-- VERIFICATION QUERIES (for manual testing)
-- ============================================================================

-- Verify grids table columns
-- SELECT column_name, data_type, character_maximum_length
-- FROM information_schema.columns
-- WHERE table_name = 'grids'
-- AND column_name IN ('contact_info', 'risks_notes', 'meeting_point')
-- ORDER BY column_name;

-- Verify volunteer_registrations table columns
-- SELECT column_name, data_type, udt_name
-- FROM information_schema.columns
-- WHERE table_name = 'volunteer_registrations'
-- AND column_name IN ('volunteer_name', 'volunteer_phone', 'available_time', 'skills', 'equipment', 'notes')
-- ORDER BY column_name;

-- ============================================================================
-- SAMPLE DATA (for testing purposes)
-- ============================================================================

-- Update sample grids with contact info and risks
UPDATE grids
SET
  contact_info = 'ËÅØÁµ°‰∫∫ÔºöÈô≥ÁµÑÈï∑ 0912-345-678',
  risks_notes = 'Ê≥®ÊÑèÔºöË∑ØÈù¢ÊøïÊªëÔºåË´ãÁ©øÈò≤ÊªëÈûã„ÄÇÊúâÂÄíÂ°åÈ¢®Èö™Âª∫ÁØâÁâ©ÔºåË´ãÂãøÈù†Ëøë„ÄÇ'
WHERE code = 'A1' AND contact_info IS NULL;

UPDATE grids
SET
  contact_info = 'ËÅØÁµ°‰∫∫ÔºöÊûó‰∏ª‰ªª 0923-456-789',
  risks_notes = 'Ê≥®ÊÑèÔºöÈÉ®ÂàÜÂçÄÂüüÊ∞¥Ê∑±ÂèäËÜùÔºåË´ãÁ©øÈõ®Èûã„ÄÇÈõªÁ∑öÂèØËÉΩË£∏Èú≤ÔºåÊ≥®ÊÑèÂÆâÂÖ®„ÄÇ'
WHERE code = 'A2' AND contact_info IS NULL;

UPDATE grids
SET
  contact_info = 'ËÅØÁµ°‰∫∫ÔºöÁéãÈöäÈï∑ 0934-567-890',
  risks_notes = 'Ê≥®ÊÑèÔºöÊ≤≥Â≤∏Ê≥•ÊøòÔºåÊúâÊªëÂÄíÈ¢®Èö™„ÄÇË´ãÊîúÂ∏∂Âè£ÁΩ©Èò≤Ê≠¢Á≤âÂ°µ„ÄÇ'
WHERE code = 'A3' AND contact_info IS NULL;

-- Note: Sample volunteer_registrations data will be added in test files
-- Example structure:
-- INSERT INTO volunteer_registrations (
--   grid_id, user_id, volunteer_name, volunteer_phone,
--   status, available_time, skills, equipment, notes
-- ) VALUES (
--   (SELECT id FROM grids WHERE code = 'A1'),
--   (SELECT id FROM users WHERE phone = '0912000001'),
--   'ÂºµÂ∞èÊòé',
--   '0912-111-222',
--   'confirmed',
--   'ÈÄ±Êú´ÂÖ®Â§©',
--   ARRAY['ÈáçÊ©üÊ¢∞Êìç‰Ωú', 'ÊÄ•Êïë'],
--   ARRAY['ÈèüÂ≠ê', 'ÊâãÂ•ó', 'Ê∞¥Ê°∂'],
--   'ÊúâÊ∏ÖÊ∑§Á∂ìÈ©ó'
-- );
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696276800000_add_missing_columns', NOW());


### MIGRATION 1696280400000_modular_rls (UP) ###
-- ============================================
-- Migration: Modular RLS Policies
-- Timestamp: 1696280400000
-- Created: 2025-10-03
-- Description: Apply modular RLS policies (inlined from sql/rls/ directory)
-- Supersedes: 0012_complete_rls_policies.sql
-- ============================================
--
-- This migration reorganizes RLS policies into modular sections for better
-- maintainability. All policies from migration 0012 are preserved but
-- now organized into logical, maintainable modules.
--
-- Original modular structure (for reference):
--   sql/rls/_helpers.sql          - Helper functions
--   sql/rls/users.sql             - Users table policies
--   sql/rls/grids.sql             - Grids table policies
--   sql/rls/disaster_areas.sql    - Disaster areas policies
--   sql/rls/announcements.sql     - Announcements policies
--   sql/rls/volunteers.sql        - Volunteers policies
--   sql/rls/volunteer_registrations.sql - Registration policies
--   sql/rls/supply_donations.sql  - Donations policies
--   sql/rls/grid_discussions.sql  - Discussions policies
--   sql/rls/auth_tables.sql       - OTP codes, login history
--   sql/rls/permissions.sql       - Permissions tables
-- ============================================

-- ============================================
-- Step 1: Drop all existing policies from 0012
-- ============================================

-- Helper functions (will be recreated)
DROP FUNCTION IF EXISTS user_has_role(TEXT[]) CASCADE;
DROP FUNCTION IF EXISTS get_current_user_id() CASCADE;
DROP FUNCTION IF EXISTS is_admin() CASCADE;
DROP FUNCTION IF EXISTS is_grid_manager(UUID) CASCADE;

-- Grids policies
DROP POLICY IF EXISTS grids_select_all ON grids;
DROP POLICY IF EXISTS grids_select_public ON grids;
DROP POLICY IF EXISTS grids_insert_admin ON grids;
DROP POLICY IF EXISTS grids_update_admin ON grids;
DROP POLICY IF EXISTS grids_delete_super_admin ON grids;

-- Announcements policies
DROP POLICY IF EXISTS announcements_select_published ON announcements;
DROP POLICY IF EXISTS announcements_select_public ON announcements;
DROP POLICY IF EXISTS announcements_insert_admin ON announcements;
DROP POLICY IF EXISTS announcements_update_author_or_admin ON announcements;
DROP POLICY IF EXISTS announcements_delete_author_or_super_admin ON announcements;

-- Volunteers policies
DROP POLICY IF EXISTS volunteers_select_all ON volunteers;
DROP POLICY IF EXISTS volunteers_select_self_or_admin ON volunteers;
DROP POLICY IF EXISTS volunteers_insert_self ON volunteers;
DROP POLICY IF EXISTS volunteers_update_self ON volunteers;
DROP POLICY IF EXISTS volunteers_delete_self_or_super_admin ON volunteers;

-- Volunteer registrations policies
DROP POLICY IF EXISTS volunteer_registrations_select_own ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_select_own_or_admin ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_insert_own ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_update_own_or_admin ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_delete_own_or_super_admin ON volunteer_registrations;

-- Disaster areas policies
DROP POLICY IF EXISTS disaster_areas_select_all ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_select_public ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_insert_admin ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_update_admin ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_delete_super_admin ON disaster_areas;

-- Supply donations policies
DROP POLICY IF EXISTS supply_donations_select_all ON supply_donations;
DROP POLICY IF EXISTS supply_donations_select_public ON supply_donations;
DROP POLICY IF EXISTS supply_donations_insert_authenticated ON supply_donations;
DROP POLICY IF EXISTS supply_donations_update_admin ON supply_donations;
DROP POLICY IF EXISTS supply_donations_delete_super_admin ON supply_donations;

-- Grid discussions policies
DROP POLICY IF EXISTS grid_discussions_select_all ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_select_public ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_insert_authenticated ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_update_author ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_delete_author_or_super_admin ON grid_discussions;

-- OTP codes policies
DROP POLICY IF EXISTS otp_codes_no_select ON otp_codes;
DROP POLICY IF EXISTS otp_codes_no_direct_insert ON otp_codes;
DROP POLICY IF EXISTS otp_codes_no_update ON otp_codes;
DROP POLICY IF EXISTS otp_codes_delete_super_admin ON otp_codes;

-- Login history policies
DROP POLICY IF EXISTS login_history_select_self_or_admin ON login_history;
DROP POLICY IF EXISTS login_history_no_direct_insert ON login_history;
DROP POLICY IF EXISTS login_history_no_update ON login_history;
DROP POLICY IF EXISTS login_history_delete_super_admin ON login_history;

-- Permissions policies
DROP POLICY IF EXISTS permissions_select_all ON permissions;
DROP POLICY IF EXISTS permissions_modify_super_admin ON permissions;

-- Role permissions policies
DROP POLICY IF EXISTS role_permissions_select_all ON role_permissions;
DROP POLICY IF EXISTS role_permissions_modify_super_admin ON role_permissions;

-- User permissions policies
DROP POLICY IF EXISTS user_permissions_select_self_or_admin ON user_permissions;
DROP POLICY IF EXISTS user_permissions_modify_super_admin ON user_permissions;

-- Users policies
DROP POLICY IF EXISTS users_select_self_or_admin ON users;
DROP POLICY IF EXISTS users_insert_system ON users;
DROP POLICY IF EXISTS users_update_self ON users;
DROP POLICY IF EXISTS users_delete_super_admin ON users;

-- ============================================
-- Step 2: Apply modular RLS policies (inlined)
-- ============================================

-- ============================================
-- MODULE: RLS Helper Functions
-- Must be applied before any table policies
-- ============================================

-- Function to check if user has one of the required roles
CREATE OR REPLACE FUNCTION user_has_role(required_roles TEXT[])
RETURNS BOOLEAN AS $$
DECLARE
  current_user_id UUID;
  current_user_role TEXT;
BEGIN
  -- Get current user ID from session context
  BEGIN
    current_user_id := current_setting('app.user_id', true)::UUID;
  EXCEPTION WHEN OTHERS THEN
    RETURN FALSE;
  END;

  -- Return false if no user context
  IF current_user_id IS NULL THEN
    RETURN FALSE;
  END IF;

  -- Get user role
  SELECT role INTO current_user_role
  FROM users
  WHERE id = current_user_id;

  -- Check if user role is in required roles
  RETURN current_user_role = ANY(required_roles);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- Function to get current user ID safely
CREATE OR REPLACE FUNCTION get_current_user_id()
RETURNS UUID AS $$
BEGIN
  RETURN current_setting('app.user_id', true)::UUID;
EXCEPTION WHEN OTHERS THEN
  RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- Function to check if user is admin (coordinator or above)
CREATE OR REPLACE FUNCTION is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin']);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- Function to check if user is grid manager for a specific grid
CREATE OR REPLACE FUNCTION is_grid_manager(grid_id_param UUID)
RETURNS BOOLEAN AS $$
DECLARE
  current_user_id UUID;
  manager_id UUID;
BEGIN
  current_user_id := get_current_user_id();

  IF current_user_id IS NULL THEN
    RETURN FALSE;
  END IF;

  SELECT grid_manager_id INTO manager_id
  FROM grids
  WHERE id = grid_id_param;

  RETURN manager_id = current_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- Grant execute permissions to public
GRANT EXECUTE ON FUNCTION user_has_role(TEXT[]) TO PUBLIC;
GRANT EXECUTE ON FUNCTION get_current_user_id() TO PUBLIC;
GRANT EXECUTE ON FUNCTION is_admin() TO PUBLIC;
GRANT EXECUTE ON FUNCTION is_grid_manager(UUID) TO PUBLIC;

-- Create indexes for faster role checks
CREATE INDEX IF NOT EXISTS idx_users_role_lookup ON users(role) WHERE role IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_grids_manager_lookup ON grids(grid_manager_id) WHERE grid_manager_id IS NOT NULL;

-- Comments
COMMENT ON FUNCTION user_has_role IS 'Check if current user has one of the specified roles. Used in RLS policies.';
COMMENT ON FUNCTION get_current_user_id IS 'Safely get current user ID from app.user_id session variable.';
COMMENT ON FUNCTION is_admin IS 'Check if current user is an admin (coordinator or above).';
COMMENT ON FUNCTION is_grid_manager IS 'Check if current user is the manager of a specific grid.';

-- ============================================
-- MODULE: RLS Policies for users table
-- Self-access and admin management
-- ============================================

ALTER TABLE users ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS users_select_self_or_admin ON users;
DROP POLICY IF EXISTS users_insert_system ON users;
DROP POLICY IF EXISTS users_update_self ON users;
DROP POLICY IF EXISTS users_delete_super_admin ON users;

-- SELECT: Users can view own profile, admins can view all
CREATE POLICY users_select_self_or_admin ON users
  FOR SELECT
  USING (
    id = get_current_user_id() OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin', 'data_analyst'])
  );

-- INSERT: Only through authentication system
CREATE POLICY users_insert_system ON users
  FOR INSERT
  WITH CHECK (false);

-- UPDATE: Users can update own profile, admins can update any user
CREATE POLICY users_update_self ON users
  FOR UPDATE
  USING (
    id = get_current_user_id() OR
    user_has_role(ARRAY['regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY users_delete_super_admin ON users
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for grids table
-- Public map data with admin-only modifications
-- ============================================

ALTER TABLE grids ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS grids_select_all ON grids;
DROP POLICY IF EXISTS grids_select_public ON grids;
DROP POLICY IF EXISTS grids_insert_admin ON grids;
DROP POLICY IF EXISTS grids_update_admin ON grids;
DROP POLICY IF EXISTS grids_delete_super_admin ON grids;

-- SELECT: Everyone can view grids
CREATE POLICY grids_select_public ON grids
  FOR SELECT
  USING (true);

-- INSERT: Only coordinators and admins
CREATE POLICY grids_insert_admin ON grids
  FOR INSERT
  WITH CHECK (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- UPDATE: Only coordinators and admins
CREATE POLICY grids_update_admin ON grids
  FOR UPDATE
  USING (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY grids_delete_super_admin ON grids
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for disaster_areas table
-- Public safety information with admin control
-- ============================================

ALTER TABLE disaster_areas ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS disaster_areas_select_all ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_select_public ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_insert_admin ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_update_admin ON disaster_areas;
DROP POLICY IF EXISTS disaster_areas_delete_super_admin ON disaster_areas;

-- SELECT: Everyone can view disaster areas
CREATE POLICY disaster_areas_select_public ON disaster_areas
  FOR SELECT
  USING (true);

-- INSERT: Only coordinators and admins
CREATE POLICY disaster_areas_insert_admin ON disaster_areas
  FOR INSERT
  WITH CHECK (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- UPDATE: Only coordinators and admins
CREATE POLICY disaster_areas_update_admin ON disaster_areas
  FOR UPDATE
  USING (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY disaster_areas_delete_super_admin ON disaster_areas
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for announcements table
-- Public announcements with author/admin control
-- ============================================

ALTER TABLE announcements ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS announcements_select_published ON announcements;
DROP POLICY IF EXISTS announcements_select_public ON announcements;
DROP POLICY IF EXISTS announcements_insert_admin ON announcements;
DROP POLICY IF EXISTS announcements_update_author_or_admin ON announcements;
DROP POLICY IF EXISTS announcements_delete_author_or_super_admin ON announcements;

-- SELECT: Published announcements visible to all, unpublished only to admins
CREATE POLICY announcements_select_public ON announcements
  FOR SELECT
  USING (published = true OR is_admin());

-- INSERT: Only coordinators and admins
CREATE POLICY announcements_insert_admin ON announcements
  FOR INSERT
  WITH CHECK (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- UPDATE: Author or admins
CREATE POLICY announcements_update_author_or_admin ON announcements
  FOR UPDATE
  USING (
    author_id = get_current_user_id() OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Author or super admin
CREATE POLICY announcements_delete_author_or_super_admin ON announcements
  FOR DELETE
  USING (
    author_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for volunteers table
-- Self-access and admin oversight
-- ============================================

ALTER TABLE volunteers ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS volunteers_select_all ON volunteers;
DROP POLICY IF EXISTS volunteers_select_self_or_admin ON volunteers;
DROP POLICY IF EXISTS volunteers_insert_self ON volunteers;
DROP POLICY IF EXISTS volunteers_update_self ON volunteers;
DROP POLICY IF EXISTS volunteers_delete_self_or_super_admin ON volunteers;

-- SELECT: Self or admins
CREATE POLICY volunteers_select_self_or_admin ON volunteers
  FOR SELECT
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin', 'data_analyst'])
  );

-- INSERT: Only self
CREATE POLICY volunteers_insert_self ON volunteers
  FOR INSERT
  WITH CHECK (
    user_id = get_current_user_id()
  );

-- UPDATE: Only self
CREATE POLICY volunteers_update_self ON volunteers
  FOR UPDATE
  USING (
    user_id = get_current_user_id()
  );

-- DELETE: Self or super admin
CREATE POLICY volunteers_delete_self_or_super_admin ON volunteers
  FOR DELETE
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for volunteer_registrations table
-- Volunteers manage own registrations, admins approve
-- ============================================

ALTER TABLE volunteer_registrations ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS volunteer_registrations_select_own ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_select_own_or_admin ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_insert_own ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_update_own_or_admin ON volunteer_registrations;
DROP POLICY IF EXISTS volunteer_registrations_delete_own_or_super_admin ON volunteer_registrations;

-- SELECT: Own registrations or admins
CREATE POLICY volunteer_registrations_select_own_or_admin ON volunteer_registrations
  FOR SELECT
  USING (
    volunteer_id IN (
      SELECT id FROM volunteers WHERE user_id = get_current_user_id()
    ) OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin', 'data_analyst'])
  );

-- INSERT: Own registrations only
CREATE POLICY volunteer_registrations_insert_own ON volunteer_registrations
  FOR INSERT
  WITH CHECK (
    volunteer_id IN (
      SELECT id FROM volunteers WHERE user_id = get_current_user_id()
    )
  );

-- UPDATE: Own pending registrations or admins
CREATE POLICY volunteer_registrations_update_own_or_admin ON volunteer_registrations
  FOR UPDATE
  USING (
    (
      volunteer_id IN (
        SELECT id FROM volunteers WHERE user_id = get_current_user_id()
      ) AND status = 'pending'
    ) OR
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Own pending registrations or super admin
CREATE POLICY volunteer_registrations_delete_own_or_super_admin ON volunteer_registrations
  FOR DELETE
  USING (
    (
      volunteer_id IN (
        SELECT id FROM volunteers WHERE user_id = get_current_user_id()
      ) AND status = 'pending'
    ) OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for supply_donations table
-- Public transparency with authenticated donations
-- ============================================

ALTER TABLE supply_donations ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS supply_donations_select_all ON supply_donations;
DROP POLICY IF EXISTS supply_donations_select_public ON supply_donations;
DROP POLICY IF EXISTS supply_donations_insert_authenticated ON supply_donations;
DROP POLICY IF EXISTS supply_donations_update_admin ON supply_donations;
DROP POLICY IF EXISTS supply_donations_delete_super_admin ON supply_donations;

-- SELECT: Everyone can view donations
CREATE POLICY supply_donations_select_public ON supply_donations
  FOR SELECT
  USING (true);

-- INSERT: Anyone authenticated
CREATE POLICY supply_donations_insert_authenticated ON supply_donations
  FOR INSERT
  WITH CHECK (
    get_current_user_id() IS NOT NULL
  );

-- UPDATE: Only coordinators
CREATE POLICY supply_donations_update_admin ON supply_donations
  FOR UPDATE
  USING (
    user_has_role(ARRAY['ngo_coordinator', 'regional_admin', 'super_admin'])
  );

-- DELETE: Only super admins
CREATE POLICY supply_donations_delete_super_admin ON supply_donations
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for grid_discussions table
-- Public forum with author control
-- ============================================

ALTER TABLE grid_discussions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS grid_discussions_select_all ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_select_public ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_insert_authenticated ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_update_author ON grid_discussions;
DROP POLICY IF EXISTS grid_discussions_delete_author_or_super_admin ON grid_discussions;

-- SELECT: Everyone can view discussions
CREATE POLICY grid_discussions_select_public ON grid_discussions
  FOR SELECT
  USING (true);

-- INSERT: Authenticated users
CREATE POLICY grid_discussions_insert_authenticated ON grid_discussions
  FOR INSERT
  WITH CHECK (
    get_current_user_id() IS NOT NULL AND
    user_id = get_current_user_id()
  );

-- UPDATE: Only author
CREATE POLICY grid_discussions_update_author ON grid_discussions
  FOR UPDATE
  USING (
    user_id = get_current_user_id()
  );

-- DELETE: Author or super admin
CREATE POLICY grid_discussions_delete_author_or_super_admin ON grid_discussions
  FOR DELETE
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for Authentication Tables
-- otp_codes and login_history
-- ============================================

-- OTP_CODES Table
ALTER TABLE otp_codes ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS otp_codes_no_select ON otp_codes;
DROP POLICY IF EXISTS otp_codes_no_direct_insert ON otp_codes;
DROP POLICY IF EXISTS otp_codes_no_update ON otp_codes;
DROP POLICY IF EXISTS otp_codes_delete_super_admin ON otp_codes;

-- SELECT: No direct access
CREATE POLICY otp_codes_no_select ON otp_codes
  FOR SELECT
  USING (false);

-- INSERT: Only through auth functions
CREATE POLICY otp_codes_no_direct_insert ON otp_codes
  FOR INSERT
  WITH CHECK (false);

-- UPDATE: Only through auth functions
CREATE POLICY otp_codes_no_update ON otp_codes
  FOR UPDATE
  USING (false);

-- DELETE: Only super admin
CREATE POLICY otp_codes_delete_super_admin ON otp_codes
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- LOGIN_HISTORY Table
ALTER TABLE login_history ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS login_history_select_self_or_admin ON login_history;
DROP POLICY IF EXISTS login_history_no_direct_insert ON login_history;
DROP POLICY IF EXISTS login_history_no_update ON login_history;
DROP POLICY IF EXISTS login_history_delete_super_admin ON login_history;

-- SELECT: Self or admins
CREATE POLICY login_history_select_self_or_admin ON login_history
  FOR SELECT
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin', 'regional_admin'])
  );

-- INSERT: Only through auth functions
CREATE POLICY login_history_no_direct_insert ON login_history
  FOR INSERT
  WITH CHECK (false);

-- UPDATE: No updates (audit trail)
CREATE POLICY login_history_no_update ON login_history
  FOR UPDATE
  USING (false);

-- DELETE: Only super admin
CREATE POLICY login_history_delete_super_admin ON login_history
  FOR DELETE
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- MODULE: RLS Policies for Permissions System
-- permissions, role_permissions, user_permissions
-- ============================================

-- PERMISSIONS Table
ALTER TABLE permissions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS permissions_select_all ON permissions;
DROP POLICY IF EXISTS permissions_modify_super_admin ON permissions;

-- SELECT: Everyone can view
CREATE POLICY permissions_select_all ON permissions
  FOR SELECT
  USING (true);

-- INSERT/UPDATE/DELETE: Only super admin
CREATE POLICY permissions_modify_super_admin ON permissions
  FOR ALL
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ROLE_PERMISSIONS Table
ALTER TABLE role_permissions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS role_permissions_select_all ON role_permissions;
DROP POLICY IF EXISTS role_permissions_modify_super_admin ON role_permissions;

-- SELECT: Everyone can view
CREATE POLICY role_permissions_select_all ON role_permissions
  FOR SELECT
  USING (true);

-- INSERT/UPDATE/DELETE: Only super admin
CREATE POLICY role_permissions_modify_super_admin ON role_permissions
  FOR ALL
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- USER_PERMISSIONS Table
ALTER TABLE user_permissions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS user_permissions_select_self_or_admin ON user_permissions;
DROP POLICY IF EXISTS user_permissions_modify_super_admin ON user_permissions;

-- SELECT: Self or admins
CREATE POLICY user_permissions_select_self_or_admin ON user_permissions
  FOR SELECT
  USING (
    user_id = get_current_user_id() OR
    user_has_role(ARRAY['super_admin', 'regional_admin'])
  );

-- INSERT/UPDATE/DELETE: Only super admin
CREATE POLICY user_permissions_modify_super_admin ON user_permissions
  FOR ALL
  USING (
    user_has_role(ARRAY['super_admin'])
  );

-- ============================================
-- Step 3: Verify all tables have RLS enabled
-- ============================================

DO $$
DECLARE
  tbl TEXT;
  tables TEXT[] := ARRAY[
    'users',
    'grids',
    'disaster_areas',
    'announcements',
    'volunteers',
    'volunteer_registrations',
    'supply_donations',
    'grid_discussions',
    'otp_codes',
    'login_history',
    'permissions',
    'role_permissions',
    'user_permissions'
  ];
BEGIN
  FOREACH tbl IN ARRAY tables
  LOOP
    -- Enable RLS (idempotent)
    EXECUTE format('ALTER TABLE %I ENABLE ROW LEVEL SECURITY', tbl);
    RAISE NOTICE 'RLS enabled for table: %', tbl;
  END LOOP;

  RAISE NOTICE 'Modular RLS policies applied successfully';
END $$;

-- ============================================
-- Step 4: Add table comments
-- ============================================

COMMENT ON TABLE users IS 'User accounts. Self-access for own data, admin access for management. RLS: modular_rls.sql';
COMMENT ON TABLE grids IS 'Grid system for disaster area management. Public read, admin write. RLS: modular_rls.sql';
COMMENT ON TABLE disaster_areas IS 'Disaster area definitions. Public read for safety, admin-only write. RLS: modular_rls.sql';
COMMENT ON TABLE announcements IS 'Public announcements. Published items visible to all, author + admin control. RLS: modular_rls.sql';
COMMENT ON TABLE volunteers IS 'Volunteer profiles. Users can manage own profile, admins can view all. RLS: modular_rls.sql';
COMMENT ON TABLE volunteer_registrations IS 'Volunteer grid registrations. Self-service with admin approval workflow. RLS: modular_rls.sql';
COMMENT ON TABLE supply_donations IS 'Supply donation tracking. Public transparency, authenticated donations. RLS: modular_rls.sql';
COMMENT ON TABLE grid_discussions IS 'Grid discussion forum. Public read, authenticated post, author edit/delete. RLS: modular_rls.sql';
COMMENT ON TABLE otp_codes IS 'One-time passwords. No direct access, managed through auth functions. RLS: modular_rls.sql';
COMMENT ON TABLE login_history IS 'Login audit trail. Immutable record, self-view + admin access. RLS: modular_rls.sql';
COMMENT ON TABLE permissions IS 'System permissions. Public read, super admin write. RLS: modular_rls.sql';
COMMENT ON TABLE role_permissions IS 'Role-permission mappings. Public read, super admin write. RLS: modular_rls.sql';
COMMENT ON TABLE user_permissions IS 'User-specific permissions. Self-view, super admin management. RLS: modular_rls.sql';

-- ============================================
-- End of Migration: Modular RLS
-- ============================================
;
INSERT INTO "public"."pgmigrations" (name, run_on) VALUES ('1696280400000_modular_rls', NOW());


Migrations complete![0m
[32m‚úì Migrations applied successfully[0m
[34m[5/5] Verifying database setup...[0m
[32m‚úì Table exists: users[0m
[32m‚úì Table exists: disaster_areas[0m
[32m‚úì Table exists: grids[0m
[32m‚úì Table exists: volunteers[0m
[32m‚úì Table exists: volunteer_registrations[0m
[32m‚úì Table exists: announcements[0m
[32m‚úì Table exists: supply_donations[0m
[32m‚úì Table exists: grid_discussions[0m
[32m‚úì Table exists: pgmigrations[0m
[32m‚úì Function exists: user_has_role()[0m
[32m‚úì Function exists: get_current_user_id()[0m
[32m‚úì Function exists: is_admin()[0m
[32m‚úì Applied 14 migrations[0m
[32m‚úì Database verification completed successfully[0m
[1m
============================================================[0m
[32m[1m  ‚úì Test Database Setup Complete![0m
[1m============================================================
[0m
[34mYou can now run tests with:[0m
[0m  npm test
[0m
[34mConnection string:[0m
[0m  postgres://postgres:postgres@localhost:5432/shovelheroes_test
[0m

> shovel-backend@0.1.0 test
> vitest run


 RUN  v3.2.4 /home/thc1006/dev/shovel-heroes/packages/backend

 ‚ùØ tests/rls/grids.rls.test.ts (16 tests | 16 failed) 961ms
   √ó RLS Policies: grids table > RLS Configuration > should have RLS enabled on grids table 120ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > RLS Configuration > should have 4 policies on grids table 59ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > SELECT policies > should allow unauthenticated users to view grids 42ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > SELECT policies > should allow all authenticated users to view grids 31ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > INSERT policies > should allow ngo_coordinator to insert grids 41ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > INSERT policies > should allow regional_admin to insert grids 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > INSERT policies > should prevent volunteer from inserting grids 56ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > INSERT policies > should prevent data_analyst from inserting grids 64ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > UPDATE policies > should allow super_admin to update grids 58ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > UPDATE policies > should allow ngo_coordinator to update grids 43ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > UPDATE policies > should prevent volunteer from updating grids 65ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > DELETE policies > should allow only super_admin to delete grids 39ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > DELETE policies > should prevent ngo_coordinator from deleting grids 45ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > DELETE policies > should prevent regional_admin from deleting grids 53ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > Grid Manager scenarios > should allow grid manager to be assigned 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó RLS Policies: grids table > Grid Manager scenarios > should verify is_grid_manager helper function works 71ms
     ‚Üí relation "volunteer_registrations" does not exist
 ‚ùØ tests/routes/users.test.ts (18 tests | 18 failed) 1194ms
   √ó Users Routes - TDD > GET /users > Success Cases > should return empty array when no users exist 182ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /users > Success Cases > should return all users without authentication (public endpoint) 54ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /users > Success Cases > should limit results to 100 users 33ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /users > Success Cases > should not expose sensitive information 47ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /users > Edge Cases > should handle Unicode characters in names 119ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /users > Edge Cases > should handle null phone numbers 62ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Success Cases > should return current user info when authenticated 67ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Success Cases > should upsert user if not exists in database (JWT-based auth) 50ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Success Cases > should return user with all expected fields 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Authentication Failures > should return 401 when no auth token is provided 49ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Authentication Failures > should return 401 when auth token is invalid 36ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Authentication Failures > should return 401 when auth token is expired 48ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Authentication Failures > should return 401 when auth token is malformed 59ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Authentication Failures > should return 401 when authorization header is missing Bearer prefix 37ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Edge Cases > should handle concurrent requests from same user 26ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > GET /me > Edge Cases > should handle very long email addresses 45ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > Security > should not expose other users data via /me endpoint 87ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Users Routes - TDD > Security > should sanitize SQL injection attempts in JWT sub claim 49ms
     ‚Üí relation "volunteer_registrations" does not exist
 ‚ùØ tests/routes/volunteers.test.ts (26 tests | 26 failed) 1569ms
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should return empty array when no volunteers exist 114ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should return volunteers with basic information 53ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should mask phone numbers when can_view_phone is false (no auth) 34ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should show masked phone numbers when authenticated (can_view_phone is true) 43ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should filter volunteers by grid_id 28ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should support pagination with limit and offset 34ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should include status_counts when include_counts=true 63ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should not include status_counts when include_counts=false 39ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Success Cases > should order volunteers by created_at DESC 79ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Query Parameter Validation > should return 400 when grid_id is not a valid UUID 68ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Query Parameter Validation > should handle negative limit gracefully 71ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Query Parameter Validation > should handle negative offset gracefully 39ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Phone Masking Logic > should mask phone number correctly for standard format 94ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Phone Masking Logic > should handle short phone numbers 53ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Phone Masking Logic > should handle null phone numbers 76ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Edge Cases > should handle volunteers with null names 72ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Edge Cases > should handle very large result sets with pagination 38ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Edge Cases > should handle concurrent requests efficiently 71ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > Security > should not leak sensitive information in error messages 57ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Unauthenticated Users > should NOT see phone numbers for unauthenticated requests 36ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Admin Users > should see full phone numbers for super_admin 49ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Admin Users > should see full phone numbers for regional_admin 49ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Grid Manager Users > should see phone numbers for volunteers in THEIR grids 38ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Grid Manager Users > should NOT see phone numbers for volunteers in OTHER grids 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Grid Manager Users > should handle grid with no manager (no permission) 28ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Regular Volunteer Users > should NOT see phone numbers for regular volunteer users 60ms
     ‚Üí relation "volunteer_registrations" does not exist
 ‚ùØ tests/routes/volunteer-registrations.test.ts (30 tests | 30 failed) 1689ms
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Success Cases > should create volunteer registration with valid data and return 201 165ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Success Cases > should allow user to register themselves as volunteer 43ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Success Cases > should allow multiple volunteers to register for same grid 32ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when grid_id is missing 39ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when volunteer_id is missing 25ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when grid_id is not a valid UUID 43ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when volunteer_id is not a valid UUID 37ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should handle non-existent grid_id 71ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Authentication & Authorization > should return 401 when no auth token is provided 52ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Authentication & Authorization > should return 401 when auth token is invalid 58ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should return empty array when no registrations exist 52ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should return all registrations without authentication (public endpoint) 44ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should order registrations by created_at DESC 63ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should limit results to 200 registrations 55ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Success Cases > should update registration status and return 200 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Success Cases > should allow volunteer to update their own registration 27ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Success Cases > should support all valid status transitions 44ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Validation Failures > should return 400 when status has invalid value 28ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Not Found Cases > should return 404 when registration does not exist 61ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Authentication & Authorization > should return 401 when no auth token is provided 69ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Authentication & Authorization > should prevent user from updating other volunteers registrations 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Success Cases > should delete registration successfully and return 204 90ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Success Cases > should allow volunteer to cancel their own registration 42ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Not Found Cases > should return 404 when registration does not exist 34ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Authentication & Authorization > should return 401 when no auth token is provided 28ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Authentication & Authorization > should prevent user from deleting other volunteers registrations 45ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > Edge Cases & Security > should handle concurrent registrations for same volunteer 58ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > Edge Cases & Security > should handle duplicate registration attempts 40ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > Edge Cases & Security > should handle rapid status updates 44ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Volunteer Registrations CRUD - TDD > Edge Cases & Security > should validate UUID format in URL parameters 56ms
     ‚Üí relation "volunteer_registrations" does not exist
 ‚ùØ tests/routes/supply-donations.test.ts (27 tests | 27 failed) 1686ms
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Success Cases > should create supply donation with valid data and return 201 185ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Success Cases > should create supply donation without optional donor_contact 51ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when grid_id is missing 36ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when grid_id is not a valid UUID 63ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when donor_name is empty 35ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when quantity is negative 69ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when quantity is zero 54ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when quantity is not an integer 84ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Authentication & Authorization > should return 401 when no auth token is provided 41ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > POST /supply-donations > Authentication & Authorization > should return 401 when auth token is invalid 50ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should return empty array when no supply donations exist 48ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should return all supply donations without authentication (public endpoint) 75ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should order donations by created_at DESC 31ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should limit results to 200 donations 47ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Success Cases > should update supply donation status and return 200 34ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Success Cases > should update quantity and notes 50ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Success Cases > should support partial updates 68ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Validation Failures > should return 400 when status has invalid value 63ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Validation Failures > should return 400 when quantity is negative 94ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Not Found Cases > should return 404 when supply donation does not exist 47ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > PUT /supply-donations/:id > Authentication & Authorization > should return 401 when no auth token is provided 36ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > DELETE /supply-donations/:id > Success Cases > should delete supply donation successfully and return 204 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > DELETE /supply-donations/:id > Not Found Cases > should return 404 when supply donation does not exist 48ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > DELETE /supply-donations/:id > Authentication & Authorization > should return 401 when no auth token is provided 34ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > Edge Cases & Security > should handle concurrent updates correctly 49ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > Edge Cases & Security > should handle Unicode characters in text fields 53ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Supply Donations CRUD - TDD > Edge Cases & Security > should sanitize SQL injection attempts 79ms
     ‚Üí relation "volunteer_registrations" does not exist
 ‚ùØ tests/integration.test.ts (29 tests | 28 failed) 2217ms
   √ó Integration Tests - Full Workflow > Complete Disaster Response Workflow > should handle complete workflow: create disaster area ‚Üí create grid ‚Üí volunteer registration 192ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Row-Level Security (RLS) Tests > should enforce RLS policies across multiple users 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Row-Level Security (RLS) Tests > should apply RLS filtering when app.user_id is set 41ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Rate Limiting Tests > should allow requests within rate limit 30ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Rate Limiting Tests > should include rate limit headers 52ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > JWT Authentication Tests > should reject requests with invalid JWT 48ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > JWT Authentication Tests > should accept valid JWT tokens 64ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > JWT Authentication Tests > should handle JWT expiration 71ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Input Validation Tests > should validate disaster area creation payload 64ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Input Validation Tests > should validate volunteer registration payload 48ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Input Validation Tests > should validate announcement payload 36ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Error Handling Tests > should return 404 for non-existent disaster area 72ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Error Handling Tests > should return 404 when updating non-existent disaster area 69ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Error Handling Tests > should return 404 when deleting non-existent disaster area 66ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Error Handling Tests > should return proper JSON error format 89ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > CRUD Operations Tests > Announcements > should create and list announcements 62ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > CRUD Operations Tests > Supply Donations > should create and list supply donations 51ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > CRUD Operations Tests > Grid Discussions > should create and list grid discussions 57ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should update grid with partial fields 57ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should update grid JSONB fields (bounds and supplies_needed) 32ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should update volunteer counts 57ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should return 404 when updating non-existent grid 135ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should return current grid when no fields provided 32ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should validate invalid grid_type in update 64ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should require authentication for grid updates 50ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Grid Update Tests > should update updated_at timestamp 54ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Data Format Tests > should use ISO 8601 format for timestamps 69ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Integration Tests - Full Workflow > Data Format Tests > should use UUIDs for all IDs 33ms
     ‚Üí relation "volunteer_registrations" does not exist
   ‚úì Integration Tests - Full Workflow > Data Format Tests > should use parameterized queries (no SQL injection)  357ms
 ‚ùØ tests/routes/grids.test.ts (47 tests | 32 failed) 3632ms
   √ó Grids CRUD - TDD London School > POST /grids > Success Cases > should create grid with valid minimal data and return 201 176ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Success Cases > should create grid with all optional fields 70ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Success Cases > should create grid with null area_id (not linked to disaster area) 51ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when code is missing 39ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when grid_type is invalid 48ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when center_lat is out of range 60ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when center_lng is out of range 81ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when bounds format is invalid 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when volunteer_needed is negative 74ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Authentication & Authorization > should return 401 when no auth token is provided 52ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Authentication & Authorization > should return 401 when auth token is invalid 41ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Authentication & Authorization > should return 401 when auth token is expired 35ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Duplicate Code Handling > should return 409 when grid code already exists 46ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > POST /grids > Foreign Key Constraints > should return 400 or 404 when area_id references non-existent disaster area 21ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Success Cases > should return empty array when no grids exist 24ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Success Cases > should return all grids without authentication (public endpoint) 54ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Success Cases > should filter grids by area_id query parameter 68ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Success Cases > should return grids ordered by code 54ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Success Cases > should limit results to 100 grids 56ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Success Cases > should include all grid fields in response 82ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Query Parameter Validation > should return 400 when area_id is not a valid UUID 70ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > GET /grids > Query Parameter Validation > should return empty array when filtering by non-existent area_id 52ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update grid with valid data and return 200 77ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should support partial updates (only update provided fields) 83ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update bounds field with valid GeoJSON-like structure 44ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update supplies_needed array 21ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update volunteer counts 39ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Validation Failures > should return 400 when status has invalid value 37ms
     ‚Üí relation "volunteer_registrations" does not exist
   √ó Grids CRUD - TDD London School > PUT /grids/:id > Validation Failures > should return 400 when grid_type has invalid value 55ms
     ‚Üí relation "volunteer_registrations" does not exist
   ‚úì Grids CRUD - TDD London School > PUT /grids/:id > Validation Failures > should return 400 when bounds format is invalid 224ms
   ‚úì Grids CRUD - TDD London School > PUT /grids/:id > Validation Failures > should return 400 when volunteer numbers are negative 182ms
   ‚úì Grids CRUD - TDD London School > PUT /grids/:id > Not Found Cases > should return 404 when grid does not exist 84ms
   ‚úì Grids CRUD - TDD London School > PUT /grids/:id > Not Found Cases > should return 400 when grid ID is not a valid UUID 26ms
   ‚úì Grids CRUD - TDD London School > PUT /grids/:id > Authentication & Authorization > should return 401 when no auth token is provided 78ms
   ‚úì Grids CRUD - TDD London School > PUT /grids/:id > Authentication & Authorization > should return 401 when auth token is invalid 102ms
   ‚úì Grids CRUD - TDD London School > DELETE /grids/:id > Success Cases > should delete grid successfully and return 204 110ms
   ‚úì Grids CRUD - TDD London School > DELETE /grids/:id > Success Cases > should cascade delete volunteer_registrations when grid is deleted 227ms
   √ó Grids CRUD - TDD London School > DELETE /grids/:id > Success Cases > should cascade delete supply_donations when grid is deleted 38ms
     ‚Üí column "name" of relation "supply_donations" does not exist
   √ó Grids CRUD - TDD London School > DELETE /grids/:id > Success Cases > should cascade delete grid_discussions when grid is deleted 134ms
     ‚Üí column "content" of relation "grid_discussions" does not exist
   ‚úì Grids CRUD - TDD London School > DELETE /grids/:id > Not Found Cases > should return 404 when grid does not exist 235ms
   ‚úì Grids CRUD - TDD London School > DELETE /grids/:id > Not Found Cases > should return 400 when grid ID is not a valid UUID 92ms
   ‚úì Grids CRUD - TDD London School > DELETE /grids/:id > Authentication & Authorization > should return 401 when no auth token is provided 44ms
   ‚úì Grids CRUD - TDD London School > DELETE /grids/:id > Authentication & Authorization > should return 401 when auth token is invalid 130ms
   √ó Grids CRUD - TDD London School > Edge Cases & Security > should handle concurrent updates correctly 35ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   ‚úì Grids CRUD - TDD London School > Edge Cases & Security > should sanitize input to prevent SQL injection 116ms
   ‚úì Grids CRUD - TDD London School > Edge Cases & Security > should handle very long text fields 26ms
   ‚úì Grids CRUD - TDD London School > Edge Cases & Security > should handle Unicode characters in text fields 21ms
stdout | tests/integration/api.test.ts > API Integration Tests
‚úì Environment variables validated successfully

 ‚ùØ tests/grids-post.test.ts (7 tests | 2 failed) 381ms
   √ó POST /grids > should create a new grid with valid data 111ms
     ‚Üí expected '23.5000000' to be 23.5 // Object.is equality
   ‚úì POST /grids > should return 400 for missing required fields 6ms
   ‚úì POST /grids > should return 400 for invalid grid_type 2ms
   ‚úì POST /grids > should return 400 for invalid coordinates 4ms
   ‚úì POST /grids > should return 401 without authentication 1ms
   √ó POST /grids > should return 409 for duplicate code 38ms
     ‚Üí expected 201 to be 409 // Object.is equality
   ‚úì POST /grids > should use default values correctly 33ms
 ‚ùØ tests/integration/api.test.ts (16 tests | 16 skipped) 245ms
   ‚Üì API Integration Tests > 1. Grids CRUD > POST /grids - should create a new grid
   ‚Üì API Integration Tests > 1. Grids CRUD > GET /grids - should list all grids
   ‚Üì API Integration Tests > 1. Grids CRUD > GET /grids?area_id - should filter grids by area
   ‚Üì API Integration Tests > 1. Grids CRUD > PUT /grids/:id - should update grid status and volunteer_needed
   ‚Üì API Integration Tests > 1. Grids CRUD > DELETE /grids/:id - should delete grid
   ‚Üì API Integration Tests > 2. Volunteer Registrations > POST /volunteer-registrations - should create registration
   ‚Üì API Integration Tests > 2. Volunteer Registrations > PUT /volunteer-registrations/:id - should update status
   ‚Üì API Integration Tests > 2. Volunteer Registrations > GET /volunteer-registrations - should list registrations
   ‚Üì API Integration Tests > 3. Supply Donations CRUD > POST /supply-donations - should create donation
   ‚Üì API Integration Tests > 3. Supply Donations CRUD > PUT /supply-donations/:id - should update donation status
   ‚Üì API Integration Tests > 3. Supply Donations CRUD > DELETE /supply-donations/:id - should delete donation
   ‚Üì API Integration Tests > 4. Announcements CRUD > POST /announcements - should create announcement
   ‚Üì API Integration Tests > 4. Announcements CRUD > PUT /announcements/:id - should update announcement
   ‚Üì API Integration Tests > 4. Announcements CRUD > DELETE /announcements/:id - should delete announcement
   ‚Üì API Integration Tests > 5. Trigger Validation - volunteer_registered counter > should auto-increment volunteer_registered on registration
   ‚Üì API Integration Tests > 5. Trigger Validation - volunteer_registered counter > should auto-decrement volunteer_registered on deletion
 ‚ùØ tests/integration/volunteer-registrations.test.ts (15 tests | 15 skipped) 447ms
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Authentication and Authorization > should return 401 when no auth token provided
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Authentication and Authorization > should return 404 when trying to update non-existent registration
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Authentication and Authorization > should return 404 when trying to update another user's registration
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Validation > should return 400 when status is missing
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Validation > should return 400 when status is invalid
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to update pending ‚Üí confirmed
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to update confirmed ‚Üí arrived
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to update arrived ‚Üí completed
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to cancel from pending status
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to cancel from confirmed status
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to cancel from arrived status
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Status Transitions - User (Owner) > should allow user to cancel from completed status
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Complete Status Flow > should allow complete flow: pending ‚Üí confirmed ‚Üí arrived ‚Üí completed
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Updated Timestamp > should update updated_at timestamp on status change
   ‚Üì PUT /volunteer-registrations/:id - Status Updates > Response Format > should return complete registration object on success
 ‚ùØ tests/routes/admin.test.ts (17 tests | 17 skipped) 166ms
   ‚Üì Admin Routes > GET /admin/users > should list users with pagination
   ‚Üì Admin Routes > GET /admin/users > should filter users by role
   ‚Üì Admin Routes > GET /admin/users > should filter users by status
   ‚Üì Admin Routes > GET /admin/users > should search users by email or phone
   ‚Üì Admin Routes > GET /admin/users > should require authentication
   ‚Üì Admin Routes > POST /admin/verify-victim > should approve victim verification
   ‚Üì Admin Routes > POST /admin/verify-victim > should reject victim verification
   ‚Üì Admin Routes > POST /admin/verify-victim > should request more info
   ‚Üì Admin Routes > POST /admin/verify-victim > should return 404 for non-existent victim
   ‚Üì Admin Routes > GET /admin/audit-logs > should get audit logs with pagination
   ‚Üì Admin Routes > GET /admin/audit-logs > should filter audit logs by user_id
   ‚Üì Admin Routes > GET /admin/audit-logs > should filter audit logs by action
   ‚Üì Admin Routes > PATCH /admin/users/:id/status > should update user status to suspended
   ‚Üì Admin Routes > PATCH /admin/users/:id/status > should update user status to active
   ‚Üì Admin Routes > PATCH /admin/users/:id/status > should prevent self-suspension
   ‚Üì Admin Routes > PATCH /admin/users/:id/status > should require super_admin role
   ‚Üì Admin Routes > GET /admin/stats > should return dashboard statistics
stdout | tests/lib/test-db-setup.test.ts > Test Database Setup > Migration Status > should list all applied migrations

Applied migrations:
  - 1696233600000_init (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696237200000_rls (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696240800000_audit (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696244400000_create_all_tables (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696248000000_expand_grids_table (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696251600000_add_announcement_fields (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696255200000_add_volunteer_registration_statuses (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696258800000_add_grid_manager_column (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696262400000_create_auth_system (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696266000000_add_grid_code_unique_constraint (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696269600000_auto_update_volunteer_count (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696273200000_complete_rls_policies (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696276800000_add_missing_columns (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))
  - 1696280400000_modular_rls (Fri Oct 03 2025 06:45:52 GMT+0800 (Taiwan Standard Time))

stdout | tests/lib/test-db-setup.test.ts > Test Database Setup > Required Tables > should have all required tables

All tables in test database:
  - announcements
  - audit_log
  - audit_logs
  - disaster_areas
  - grid_discussions
  - grids
  - login_history
  - otp_codes
  - permissions
  - pgmigrations
  - role_permissions
  - sessions
  - supply_donations
  - user_permissions
  - users
  - victim_profiles
  - volunteer_profiles
  - volunteer_registrations
  - volunteers

stdout | tests/lib/test-db-setup.test.ts > Test Database Setup > Row-Level Security (RLS) > should list all RLS policies

RLS Policies:
  - announcements.announcements_delete_author_or_super_admin (DELETE)
  - announcements.announcements_insert_admin (INSERT)
  - announcements.announcements_select_public (SELECT)
  - announcements.announcements_update_author_or_admin (UPDATE)
  - disaster_areas.disaster_areas_delete_super_admin (DELETE)
  - disaster_areas.disaster_areas_insert_admin (INSERT)
  - disaster_areas.disaster_areas_select_public (SELECT)
  - disaster_areas.disaster_areas_update_admin (UPDATE)
  - grid_discussions.grid_discussions_delete_author_or_super_admin (DELETE)
  - grid_discussions.grid_discussions_insert_authenticated (INSERT)
  - grid_discussions.grid_discussions_select_public (SELECT)
  - grid_discussions.grid_discussions_update_author (UPDATE)
  - grids.grids_delete_super_admin (DELETE)
  - grids.grids_insert_admin (INSERT)
  - grids.grids_select_public (SELECT)
  - grids.grids_update_admin (UPDATE)
  - login_history.login_history_delete_super_admin (DELETE)
  - login_history.login_history_no_direct_insert (INSERT)
  - login_history.login_history_no_update (UPDATE)
  - login_history.login_history_select_self_or_admin (SELECT)
  - otp_codes.otp_codes_delete_super_admin (DELETE)
  - otp_codes.otp_codes_no_direct_insert (INSERT)
  - otp_codes.otp_codes_no_select (SELECT)
  - otp_codes.otp_codes_no_update (UPDATE)
  - permissions.permissions_modify_super_admin (ALL)
  - permissions.permissions_select_all (SELECT)
  - role_permissions.role_permissions_modify_super_admin (ALL)
  - role_permissions.role_permissions_select_all (SELECT)
  - supply_donations.supply_donations_delete_super_admin (DELETE)
  - supply_donations.supply_donations_insert_authenticated (INSERT)
  - supply_donations.supply_donations_select_public (SELECT)
  - supply_donations.supply_donations_update_admin (UPDATE)
  - user_permissions.user_permissions_modify_super_admin (ALL)
  - user_permissions.user_permissions_select_self_or_admin (SELECT)
  - users.users_admin_access (ALL)
  - users.users_delete_super_admin (DELETE)
  - users.users_insert_system (INSERT)
  - users.users_select_self_or_admin (SELECT)
  - users.users_self_access (SELECT)
  - users.users_update_self (UPDATE)
  - volunteer_profiles.volunteer_ngo_access (SELECT)
  - volunteer_profiles.volunteer_self_access (ALL)
  - volunteer_registrations.volunteer_registrations_delete_own_or_super_admin (DELETE)
  - volunteer_registrations.volunteer_registrations_insert_own (INSERT)
  - volunteer_registrations.volunteer_registrations_select_own_or_admin (SELECT)
  - volunteer_registrations.volunteer_registrations_update_own (UPDATE)
  - volunteer_registrations.volunteer_registrations_update_own_or_admin (UPDATE)
  - volunteers.volunteers_delete_self_or_super_admin (DELETE)
  - volunteers.volunteers_insert_self (INSERT)
  - volunteers.volunteers_select_self_or_admin (SELECT)
  - volunteers.volunteers_update_self (UPDATE)

 ‚ùØ tests/routes/grid-discussions.test.ts (21 tests | 16 failed) 2221ms
   √ó Grid Discussions Routes - TDD > POST /grid-discussions > Success Cases > should create grid discussion with valid data and return 201 315ms
     ‚Üí expected 500 to be 201 // Object.is equality
   √ó Grid Discussions Routes - TDD > POST /grid-discussions > Success Cases > should associate discussion with authenticated user from JWT 46ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > POST /grid-discussions > Success Cases > should handle multiple discussions on same grid 137ms
     ‚Üí expected 500 to be 201 // Object.is equality
   ‚úì Grid Discussions Routes - TDD > POST /grid-discussions > Validation Failures > should return 400 when grid_id is missing 30ms
   ‚úì Grid Discussions Routes - TDD > POST /grid-discussions > Validation Failures > should return 400 when grid_id is not a valid UUID 19ms
   ‚úì Grid Discussions Routes - TDD > POST /grid-discussions > Validation Failures > should return 400 when content is missing 33ms
   ‚úì Grid Discussions Routes - TDD > POST /grid-discussions > Validation Failures > should return 400 when content is empty string 24ms
   ‚úì Grid Discussions Routes - TDD > POST /grid-discussions > Validation Failures > should handle non-existent grid_id 45ms
   √ó Grid Discussions Routes - TDD > POST /grid-discussions > Authentication & Authorization > should return 401 when no auth token is provided 12ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > POST /grid-discussions > Authentication & Authorization > should return 401 when auth token is invalid 140ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > POST /grid-discussions > Authentication & Authorization > should return 401 when auth token is expired 84ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should return empty array when no discussions exist 110ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should return all grid discussions without authentication (public endpoint) 106ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should order discussions by created_at DESC 112ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should limit results to 200 discussions 111ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should include discussions from multiple grids 95ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > Edge Cases & Security > should handle Unicode characters in content 122ms
     ‚Üí expected 500 to be 201 // Object.is equality
   √ó Grid Discussions Routes - TDD > Edge Cases & Security > should handle very long content 27ms
     ‚Üí update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
   √ó Grid Discussions Routes - TDD > Edge Cases & Security > should sanitize SQL injection attempts 183ms
     ‚Üí expected 500 to be 201 // Object.is equality
   √ó Grid Discussions Routes - TDD > Edge Cases & Security > should handle concurrent posts efficiently 165ms
     ‚Üí expected 500 to be 201 // Object.is equality
   √ó Grid Discussions Routes - TDD > Edge Cases & Security > should handle XSS attempts in content 53ms
     ‚Üí expected 500 to be 201 // Object.is equality
 ‚úì tests/lib/test-db-setup.test.ts (34 tests) 487ms
 ‚úì tests/schema/migration-0013.test.ts (15 tests) 426ms
stdout | tests/routes/debug.test.ts > Debug Routes
‚úì Environment variables validated successfully

 ‚ùØ tests/routes/announcements.test.ts (29 tests | 3 failed) 3049ms
   √ó Announcements CRUD - TDD > POST /announcements > Success Cases > should create announcement with valid data and return 201 467ms
     ‚Üí expected 500 to be 201 // Object.is equality
   ‚úì Announcements CRUD - TDD > POST /announcements > Success Cases > should create announcement with default values 119ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Success Cases > should create unpublished announcement 44ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Success Cases > should create announcement with all priority levels 130ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Validation Failures > should return 400 when title is missing 43ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Validation Failures > should return 400 when title is empty string 51ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Validation Failures > should return 400 when content is missing 40ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Validation Failures > should return 400 when priority has invalid value 26ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Authentication & Authorization > should return 401 when no auth token is provided 22ms
   ‚úì Announcements CRUD - TDD > POST /announcements > Authentication & Authorization > should return 401 when auth token is invalid 10ms
   ‚úì Announcements CRUD - TDD > GET /announcements > Success Cases > should return empty array when no announcements exist 26ms
   ‚úì Announcements CRUD - TDD > GET /announcements > Success Cases > should return only published announcements (public endpoint) 38ms
   √ó Announcements CRUD - TDD > GET /announcements > Success Cases > should return announcements without authentication (public endpoint) 48ms
     ‚Üí expected [ { ‚Ä¶(13) }, { ‚Ä¶(13) } ] to have a length of 3 but got 2
   ‚úì Announcements CRUD - TDD > GET /announcements > Success Cases > should order announcements by is_pinned DESC, order ASC, created_at DESC 73ms
   √ó Announcements CRUD - TDD > GET /announcements > Success Cases > should limit results to 100 announcements 700ms
     ‚Üí expected [ { ‚Ä¶(13) }, { ‚Ä¶(13) }, ‚Ä¶(9) ] to have a length of 100 but got 11
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Success Cases > should update announcement and return 200 150ms
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Success Cases > should support partial updates 60ms
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Success Cases > should update published status 49ms
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Validation Failures > should return 400 when title is empty string 65ms
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Validation Failures > should return 400 when priority has invalid value 60ms
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Not Found Cases > should return 404 when announcement does not exist 63ms
   ‚úì Announcements CRUD - TDD > PUT /announcements/:id > Authentication & Authorization > should return 401 when no auth token is provided 56ms
   ‚úì Announcements CRUD - TDD > DELETE /announcements/:id > Success Cases > should delete announcement successfully and return 204 114ms
   ‚úì Announcements CRUD - TDD > DELETE /announcements/:id > Not Found Cases > should return 404 when announcement does not exist 161ms
   ‚úì Announcements CRUD - TDD > DELETE /announcements/:id > Authentication & Authorization > should return 401 when no auth token is provided 82ms
   ‚úì Announcements CRUD - TDD > Edge Cases & Security > should handle Unicode characters in text fields 30ms
   ‚úì Announcements CRUD - TDD > Edge Cases & Security > should handle very long content 34ms
   ‚úì Announcements CRUD - TDD > Edge Cases & Security > should sanitize SQL injection attempts 32ms
   ‚úì Announcements CRUD - TDD > Edge Cases & Security > should handle concurrent updates correctly 80ms
 ‚úì src/index.test.ts (1 test) 251ms
 ‚úì tests/lib/email.test.ts (13 tests) 23ms
 ‚úì tests/lib/openapi-types.test.ts (18 tests) 27ms
 ‚úì tests/routes/debug.test.ts (8 tests) 672ms
stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should initialize OTel SDK when OTEL_ENABLED is true
‚úì OpenTelemetry: Using console exporter (no OTLP endpoint configured)

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should initialize OTel SDK when OTEL_ENABLED is true
‚úì OpenTelemetry: Initialized successfully
  Service: test-service
  Environment: development
  Exporter: console

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should skip initialization when OTEL_ENABLED is false
‚äò OpenTelemetry: Disabled via OTEL_ENABLED=false

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should handle initialization errors gracefully
‚úì OpenTelemetry: Using OTLP exporter (invalid://endpoint)

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should handle initialization errors gracefully
‚úì OpenTelemetry: Initialized successfully
  Service: shovel-heroes-api
  Environment: development
  Exporter: otlp

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should shutdown gracefully
‚úì OpenTelemetry: Using console exporter (no OTLP endpoint configured)

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should shutdown gracefully
‚úì OpenTelemetry: Initialized successfully
  Service: shovel-heroes-api
  Environment: development
  Exporter: console

stdout | tests/otel/init.test.ts > OpenTelemetry Initialization > should shutdown gracefully
‚úì OpenTelemetry: Shutdown complete

 ‚úì tests/otel/init.test.ts (11 tests) 3823ms
   ‚úì OpenTelemetry Initialization > should initialize OTel SDK when OTEL_ENABLED is true  3642ms
stdout | process.<anonymous> (/home/thc1006/dev/shovel-heroes/packages/backend/src/otel/init.ts:148:15)
OpenTelemetry: Shutting down...
OpenTelemetry: Shutting down...
OpenTelemetry: Shutting down...

stdout | shutdownOTel (/home/thc1006/dev/shovel-heroes/packages/backend/src/otel/init.ts:180:13)
‚úì OpenTelemetry: Shutdown complete

stdout | shutdownOTel (/home/thc1006/dev/shovel-heroes/packages/backend/src/otel/init.ts:180:13)
‚úì OpenTelemetry: Shutdown complete


‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Suites 3 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  tests/integration/api.test.ts > API Integration Tests
Error: Failed to create test user: {"message":"Route POST:/register not found","error":"Not Found","statusCode":404}
 ‚ùØ tests/integration/api.test.ts:36:13
     34| 
     35|     if (registerResponse.statusCode !== 201) {
     36|       throw new Error(`Failed to create test user: ${registerResponse.‚Ä¶
       |             ^
     37|     }
     38| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/202]‚éØ

 FAIL  tests/integration/volunteer-registrations.test.ts > PUT /volunteer-registrations/:id - Status Updates
error: column "latitude" of relation "grids" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ tests/integration/volunteer-registrations.test.ts:40:24
     38| 
     39|     // Create a test grid
     40|     const gridResult = await context.pool.query(
       |                        ^
     41|       'INSERT INTO grids (name, latitude, longitude) VALUES ($1, $2, $‚Ä¶
     42|       ['Test Grid', 23.5, 121.5]

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/202]‚éØ

 FAIL  tests/routes/admin.test.ts > Admin Routes
TypeError: (0 , buildApp) is not a function
 ‚ùØ tests/routes/admin.test.ts:14:17
     12| 
     13|   beforeAll(async () => {
     14|     app = await buildApp();
       |                 ^
     15| 
     16|     // Create test super admin

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/202]‚éØ

 FAIL  tests/routes/admin.test.ts > Admin Routes
TypeError: Cannot read properties of undefined (reading 'close')
 ‚ùØ tests/routes/admin.test.ts:91:15
     89|     await pool.query('DELETE FROM users WHERE id = ANY($1)', [[adminUs‚Ä¶
     90|     await pool.query('DELETE FROM audit_logs WHERE user_id = $1', [adm‚Ä¶
     91|     await app.close();
       |               ^
     92|   });
     93| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/202]‚éØ


‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 198 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  tests/grids-post.test.ts > POST /grids > should create a new grid with valid data
AssertionError: expected '23.5000000' to be 23.5 // Object.is equality

[32m- Expected:[39m 
23.5

[31m+ Received:[39m 
"23.5000000"

 ‚ùØ tests/grids-post.test.ts:93:29
     91|     expect(data.name).toBe('Test Grid');
     92|     expect(data.grid_type).toBe('manpower');
     93|     expect(data.center_lat).toBe(23.5);
       |                             ^
     94|     expect(data.center_lng).toBe(121.5);
     95|     expect(data.volunteer_needed).toBe(10);

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/202]‚éØ

 FAIL  tests/grids-post.test.ts > POST /grids > should return 409 for duplicate code
AssertionError: expected 201 to be 409 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 201[39m

 ‚ùØ tests/grids-post.test.ts:212:42
    210|     });
    211| 
    212|     expect(duplicateResponse.statusCode).toBe(409);
       |                                          ^
    213|     const duplicateData = JSON.parse(duplicateResponse.body);
    214|     expect(duplicateData).toHaveProperty('message', 'Grid code already‚Ä¶

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/202]‚éØ

 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Complete Disaster Response Workflow > should handle complete workflow: create disaster area ‚Üí create grid ‚Üí volunteer registration
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Row-Level Security (RLS) Tests > should enforce RLS policies across multiple users
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Row-Level Security (RLS) Tests > should apply RLS filtering when app.user_id is set
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Rate Limiting Tests > should allow requests within rate limit
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Rate Limiting Tests > should include rate limit headers
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > JWT Authentication Tests > should reject requests with invalid JWT
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > JWT Authentication Tests > should accept valid JWT tokens
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > JWT Authentication Tests > should handle JWT expiration
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Input Validation Tests > should validate disaster area creation payload
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Input Validation Tests > should validate volunteer registration payload
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Input Validation Tests > should validate announcement payload
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Error Handling Tests > should return 404 for non-existent disaster area
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Error Handling Tests > should return 404 when updating non-existent disaster area
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Error Handling Tests > should return 404 when deleting non-existent disaster area
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Error Handling Tests > should return proper JSON error format
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > CRUD Operations Tests > Announcements > should create and list announcements
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > CRUD Operations Tests > Supply Donations > should create and list supply donations
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > CRUD Operations Tests > Grid Discussions > should create and list grid discussions
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should update grid with partial fields
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should update grid JSONB fields (bounds and supplies_needed)
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should update volunteer counts
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should return 404 when updating non-existent grid
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should return current grid when no fields provided
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should validate invalid grid_type in update
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should require authentication for grid updates
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Grid Update Tests > should update updated_at timestamp
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Data Format Tests > should use ISO 8601 format for timestamps
 FAIL  tests/integration.test.ts > Integration Tests - Full Workflow > Data Format Tests > should use UUIDs for all IDs
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/integration.test.ts:27:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/202]‚éØ

 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > RLS Configuration > should have RLS enabled on grids table
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > RLS Configuration > should have 4 policies on grids table
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > SELECT policies > should allow unauthenticated users to view grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > SELECT policies > should allow all authenticated users to view grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > INSERT policies > should allow ngo_coordinator to insert grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > INSERT policies > should allow regional_admin to insert grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > INSERT policies > should prevent volunteer from inserting grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > INSERT policies > should prevent data_analyst from inserting grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > UPDATE policies > should allow super_admin to update grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > UPDATE policies > should allow ngo_coordinator to update grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > UPDATE policies > should prevent volunteer from updating grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > DELETE policies > should allow only super_admin to delete grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > DELETE policies > should prevent ngo_coordinator from deleting grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > DELETE policies > should prevent regional_admin from deleting grids
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > Grid Manager scenarios > should allow grid manager to be assigned
 FAIL  tests/rls/grids.rls.test.ts > RLS Policies: grids table > Grid Manager scenarios > should verify is_grid_manager helper function works
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/rls/grids.rls.test.ts:27:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[8/202]‚éØ

 FAIL  tests/routes/announcements.test.ts > Announcements CRUD - TDD > POST /announcements > Success Cases > should create announcement with valid data and return 201
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/announcements.test.ts:52:37
     50| 
     51|         // Assert
     52|         expect(response.statusCode).toBe(201);
       |                                     ^
     53|         const created = response.json();
     54|         expect(created.title).toBe('Important Update');

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[9/202]‚éØ

 FAIL  tests/routes/announcements.test.ts > Announcements CRUD - TDD > GET /announcements > Success Cases > should return announcements without authentication (public endpoint)
AssertionError: expected [ { ‚Ä¶(13) }, { ‚Ä¶(13) } ] to have a length of 3 but got 2

[32m- Expected[39m
[31m+ Received[39m

[32m- 3[39m
[31m+ 2[39m

 ‚ùØ tests/routes/announcements.test.ts:388:31
    386|         expect(response.statusCode).toBe(200);
    387|         const announcements = response.json();
    388|         expect(announcements).toHaveLength(3);
       |                               ^
    389|         expect(announcements[0]).toHaveProperty('id');
    390|         expect(announcements[0]).toHaveProperty('title');

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[10/202]‚éØ

 FAIL  tests/routes/announcements.test.ts > Announcements CRUD - TDD > GET /announcements > Success Cases > should limit results to 100 announcements
AssertionError: expected [ { ‚Ä¶(13) }, { ‚Ä¶(13) }, ‚Ä¶(9) ] to have a length of 100 but got 11

[32m- Expected[39m
[31m+ Received[39m

[32m- 100[39m
[31m+ 11[39m

 ‚ùØ tests/routes/announcements.test.ts:465:31
    463|         expect(response.statusCode).toBe(200);
    464|         const announcements = response.json();
    465|         expect(announcements).toHaveLength(100); // Should limit to 100
       |                               ^
    466|       });
    467|     });

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[11/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > POST /grid-discussions > Success Cases > should create grid discussion with valid data and return 201
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/grid-discussions.test.ts:54:37
     52| 
     53|         // Assert
     54|         expect(response.statusCode).toBe(201);
       |                                     ^
     55|         const created = response.json();
     56|         expect(created.grid_id).toBe(grid.id);

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[12/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > POST /grid-discussions > Success Cases > should associate discussion with authenticated user from JWT
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > POST /grid-discussions > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > POST /grid-discussions > Authentication & Authorization > should return 401 when auth token is invalid
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > POST /grid-discussions > Authentication & Authorization > should return 401 when auth token is expired
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should return empty array when no discussions exist
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should return all grid discussions without authentication (public endpoint)
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should order discussions by created_at DESC
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should limit results to 200 discussions
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > GET /grid-discussions > Success Cases > should include discussions from multiple grids
 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > Edge Cases & Security > should handle very long content
error: update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/grid-discussions.test.ts:25:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[13/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > POST /grid-discussions > Success Cases > should handle multiple discussions on same grid
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/grid-discussions.test.ts:131:38
    129| 
    130|         // Assert
    131|         expect(response1.statusCode).toBe(201);
       |                                      ^
    132|         expect(response2.statusCode).toBe(201);
    133|         const discussion1 = response1.json();

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[14/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > Edge Cases & Security > should handle Unicode characters in content
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/grid-discussions.test.ts:553:35
    551| 
    552|       // Assert
    553|       expect(response.statusCode).toBe(201);
       |                                   ^
    554|       const created = response.json();
    555|       expect(created.content).toBe('ÈÄôË£°ÈúÄË¶ÅÊõ¥Â§öÂøóÂ∑•ÔºÅüòä Let\'s help together! ‚Ä¶

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[15/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > Edge Cases & Security > should sanitize SQL injection attempts
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/grid-discussions.test.ts:610:35
    608| 
    609|       // Assert - Should create successfully with sanitized input
    610|       expect(response.statusCode).toBe(201);
       |                                   ^
    611|       const created = response.json();
    612|       expect(created.content).toBe("'; DROP TABLE grid_discussions; --‚Ä¶

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[16/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > Edge Cases & Security > should handle concurrent posts efficiently
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/grid-discussions.test.ts:647:37
    645|       // Assert - All should succeed
    646|       responses.forEach((response, i) => {
    647|         expect(response.statusCode).toBe(201);
       |                                     ^
    648|         const created = response.json();
    649|         expect(created.content).toBe(`Concurrent message ${i + 1}`);
 ‚ùØ tests/routes/grid-discussions.test.ts:646:17

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[17/202]‚éØ

 FAIL  tests/routes/grid-discussions.test.ts > Grid Discussions Routes - TDD > Edge Cases & Security > should handle XSS attempts in content
AssertionError: expected 500 to be 201 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

 ‚ùØ tests/routes/grid-discussions.test.ts:683:35
    681| 
    682|       // Assert - Should store as-is (sanitization should happen on fr‚Ä¶
    683|       expect(response.statusCode).toBe(201);
       |                                   ^
    684|       const created = response.json();
    685|       expect(created.content).toBe('<script>alert("XSS")</script>');

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[18/202]‚éØ

 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Success Cases > should create grid with valid minimal data and return 201
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Success Cases > should create grid with all optional fields
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Success Cases > should create grid with null area_id (not linked to disaster area)
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when code is missing
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when grid_type is invalid
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when center_lat is out of range
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when center_lng is out of range
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when bounds format is invalid
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Validation Failures > should return 400 when volunteer_needed is negative
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Authentication & Authorization > should return 401 when auth token is invalid
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Authentication & Authorization > should return 401 when auth token is expired
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Duplicate Code Handling > should return 409 when grid code already exists
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > POST /grids > Foreign Key Constraints > should return 400 or 404 when area_id references non-existent disaster area
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Success Cases > should return empty array when no grids exist
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Success Cases > should return all grids without authentication (public endpoint)
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Success Cases > should filter grids by area_id query parameter
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Success Cases > should return grids ordered by code
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Success Cases > should limit results to 100 grids
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Success Cases > should include all grid fields in response
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Query Parameter Validation > should return 400 when area_id is not a valid UUID
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > GET /grids > Query Parameter Validation > should return empty array when filtering by non-existent area_id
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update grid with valid data and return 200
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should support partial updates (only update provided fields)
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update bounds field with valid GeoJSON-like structure
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update supplies_needed array
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Success Cases > should update volunteer counts
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Validation Failures > should return 400 when status has invalid value
 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > PUT /grids/:id > Validation Failures > should return 400 when grid_type has invalid value
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/grids.test.ts:26:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[19/202]‚éØ

 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > DELETE /grids/:id > Success Cases > should cascade delete supply_donations when grid is deleted
error: column "name" of relation "supply_donations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ tests/routes/grids.test.ts:1162:9
    1160| 
    1161|         // Create supply donations
    1162|         await pool.query(
       |         ^
    1163|           `INSERT INTO supply_donations (id, grid_id, name, quantity, ‚Ä¶
    1164|            VALUES (gen_random_uuid(), $1, $2, $3, $4, $5)`,

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[20/202]‚éØ

 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > DELETE /grids/:id > Success Cases > should cascade delete grid_discussions when grid is deleted
error: column "content" of relation "grid_discussions" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ tests/routes/grids.test.ts:1209:9
    1207| 
    1208|         // Create grid discussions
    1209|         await pool.query(
       |         ^
    1210|           `INSERT INTO grid_discussions (id, grid_id, user_id, content)
    1211|            VALUES (gen_random_uuid(), $1, $2, $3)`,

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[21/202]‚éØ

 FAIL  tests/routes/grids.test.ts > Grids CRUD - TDD London School > Edge Cases & Security > should handle concurrent updates correctly
error: update or delete on table "users" violates foreign key constraint "announcements_author_id_fkey" on table "announcements"
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/grids.test.ts:26:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22/202]‚éØ

 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Success Cases > should create supply donation with valid data and return 201
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Success Cases > should create supply donation without optional donor_contact
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when grid_id is missing
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when grid_id is not a valid UUID
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when donor_name is empty
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when quantity is negative
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when quantity is zero
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Validation Failures > should return 400 when quantity is not an integer
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > POST /supply-donations > Authentication & Authorization > should return 401 when auth token is invalid
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should return empty array when no supply donations exist
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should return all supply donations without authentication (public endpoint)
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should order donations by created_at DESC
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > GET /supply-donations > Success Cases > should limit results to 200 donations
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Success Cases > should update supply donation status and return 200
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Success Cases > should update quantity and notes
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Success Cases > should support partial updates
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Validation Failures > should return 400 when status has invalid value
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Validation Failures > should return 400 when quantity is negative
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Not Found Cases > should return 404 when supply donation does not exist
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > PUT /supply-donations/:id > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > DELETE /supply-donations/:id > Success Cases > should delete supply donation successfully and return 204
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > DELETE /supply-donations/:id > Not Found Cases > should return 404 when supply donation does not exist
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > DELETE /supply-donations/:id > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > Edge Cases & Security > should handle concurrent updates correctly
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > Edge Cases & Security > should handle Unicode characters in text fields
 FAIL  tests/routes/supply-donations.test.ts > Supply Donations CRUD - TDD > Edge Cases & Security > should sanitize SQL injection attempts
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/supply-donations.test.ts:25:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[23/202]‚éØ

 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /users > Success Cases > should return empty array when no users exist
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /users > Success Cases > should return all users without authentication (public endpoint)
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /users > Success Cases > should limit results to 100 users
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /users > Success Cases > should not expose sensitive information
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /users > Edge Cases > should handle Unicode characters in names
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /users > Edge Cases > should handle null phone numbers
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Success Cases > should return current user info when authenticated
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Success Cases > should upsert user if not exists in database (JWT-based auth)
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Success Cases > should return user with all expected fields
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Authentication Failures > should return 401 when no auth token is provided
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Authentication Failures > should return 401 when auth token is invalid
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Authentication Failures > should return 401 when auth token is expired
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Authentication Failures > should return 401 when auth token is malformed
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Authentication Failures > should return 401 when authorization header is missing Bearer prefix
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Edge Cases > should handle concurrent requests from same user
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > GET /me > Edge Cases > should handle very long email addresses
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > Security > should not expose other users data via /me endpoint
 FAIL  tests/routes/users.test.ts > Users Routes - TDD > Security > should sanitize SQL injection attempts in JWT sub claim
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/users.test.ts:23:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[24/202]‚éØ

 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Success Cases > should create volunteer registration with valid data and return 201
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Success Cases > should allow user to register themselves as volunteer
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Success Cases > should allow multiple volunteers to register for same grid
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when grid_id is missing
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when volunteer_id is missing
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when grid_id is not a valid UUID
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should return 400 when volunteer_id is not a valid UUID
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Validation Failures > should handle non-existent grid_id
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > POST /volunteer-registrations > Authentication & Authorization > should return 401 when auth token is invalid
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should return empty array when no registrations exist
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should return all registrations without authentication (public endpoint)
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should order registrations by created_at DESC
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > GET /volunteer-registrations > Success Cases > should limit results to 200 registrations
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Success Cases > should update registration status and return 200
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Success Cases > should allow volunteer to update their own registration
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Success Cases > should support all valid status transitions
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Validation Failures > should return 400 when status has invalid value
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Not Found Cases > should return 404 when registration does not exist
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > PUT /volunteer-registrations/:id > Authentication & Authorization > should prevent user from updating other volunteers registrations
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Success Cases > should delete registration successfully and return 204
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Success Cases > should allow volunteer to cancel their own registration
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Not Found Cases > should return 404 when registration does not exist
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Authentication & Authorization > should return 401 when no auth token is provided
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > DELETE /volunteer-registrations/:id > Authentication & Authorization > should prevent user from deleting other volunteers registrations
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > Edge Cases & Security > should handle concurrent registrations for same volunteer
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > Edge Cases & Security > should handle duplicate registration attempts
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > Edge Cases & Security > should handle rapid status updates
 FAIL  tests/routes/volunteer-registrations.test.ts > Volunteer Registrations CRUD - TDD > Edge Cases & Security > should validate UUID format in URL parameters
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/volunteer-registrations.test.ts:26:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[25/202]‚éØ

 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should return empty array when no volunteers exist
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should return volunteers with basic information
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should mask phone numbers when can_view_phone is false (no auth)
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should show masked phone numbers when authenticated (can_view_phone is true)
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should filter volunteers by grid_id
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should support pagination with limit and offset
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should include status_counts when include_counts=true
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should not include status_counts when include_counts=false
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Success Cases > should order volunteers by created_at DESC
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Query Parameter Validation > should return 400 when grid_id is not a valid UUID
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Query Parameter Validation > should handle negative limit gracefully
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Query Parameter Validation > should handle negative offset gracefully
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Phone Masking Logic > should mask phone number correctly for standard format
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Phone Masking Logic > should handle short phone numbers
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Phone Masking Logic > should handle null phone numbers
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Edge Cases > should handle volunteers with null names
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Edge Cases > should handle very large result sets with pagination
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Edge Cases > should handle concurrent requests efficiently
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > Security > should not leak sensitive information in error messages
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Unauthenticated Users > should NOT see phone numbers for unauthenticated requests
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Admin Users > should see full phone numbers for super_admin
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Admin Users > should see full phone numbers for regional_admin
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Grid Manager Users > should see phone numbers for volunteers in THEIR grids
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Grid Manager Users > should NOT see phone numbers for volunteers in OTHER grids
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Grid Manager Users > should handle grid with no manager (no permission)
 FAIL  tests/routes/volunteers.test.ts > Volunteers Routes - TDD > GET /volunteers > RBAC - Phone Number Visibility > Regular Volunteer Users > should NOT see phone numbers for regular volunteer users
error: relation "volunteer_registrations" does not exist
 ‚ùØ ../../node_modules/pg-pool/index.js:45:11
 ‚ùØ cleanDatabase tests/helpers.ts:119:5
    117| 
    118|   for (const table of tables) {
    119|     await pool.query(`DELETE FROM ${table}`);
       |     ^
    120|   }
    121| }
 ‚ùØ tests/routes/volunteers.test.ts:26:5

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[26/202]‚éØ


 Test Files  13 failed | 7 passed (20)
      Tests  198 failed | 152 passed | 48 skipped (398)
   Start at  14:45:48
   Duration  12.31s (transform 3.29s, setup 0ms, collect 21.89s, tests 25.16s, environment 44ms, prepare 6.41s)

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /home/thc1006/dev/shovel-heroes/packages/backend
npm error workspace shovel-backend@0.1.0
npm error location /home/thc1006/dev/shovel-heroes/packages/backend
npm error command failed
npm error command sh -c vitest run
